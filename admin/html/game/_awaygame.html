<!DOCTYPE HTML>
<?
	include "dbconn.php";
	$option = $_GET['option'];
	// 페이지 분할 1
	if($_GET['pn'] == null || $_GET['pn'] <=0){
		$pn = 1;
	}else{
		$pn = $_GET['pn'];
	}
	$pn_count = 15; //페이지 개수
	$start_pn = $pn_count * ($pn - 1);
	$page_query = "LIMIT ".$pn_count." OFFSET ".$start_pn;
	
	if(!$option){
		$query = "SELECT * FROM game WHERE deleted_at is null AND kind = '2' ORDER BY created_at DESC ".$page_query;
		$query_count = "SELECT COUNT(*) as count FROM game WHERE deleted_at is null AND kind = '2' ORDER BY created_at DESC";
	}else if($option == 'team'){
		$search = $_GET['search'];
		$query = "SELECT game.* FROM game JOIN team WHERE team.name LIKE '%$search%' AND game.team = team.no AND game.deleted_at is null AND kind = '2' ORDER BY game.created_at DESC ".$page_query;
		$query_count = "SELECT COUNT(*) as count FROM game JOIN team WHERE team.name LIKE '%$search%' AND game.team = team.no AND game.deleted_at is null AND kind = '2' ORDER BY game.created_at DESC";
	}else if($option == 'user'){
		$search = $_GET['search'];
		$query = "SELECT game.* FROM game JOIN user WHERE user.name LIKE '%$search%' AND game.user = user.no AND game.deleted_at is null AND kind = '2' ORDER BY game.created_at DESC ".$page_query;
		$query_count = "SELECT COUNT(*) as count FROM game JOIN user WHERE user.name LIKE '%$search%' AND game.user = user.no AND game.deleted_at is null AND kind = '2' ORDER BY game.created_at DESC";
	}else if($option == 'title'){
		$search = $_GET['search'];
		$query = "SELECT * FROM game WHERE title LIKE '%$search%' AND game.deleted_at is null AND kind = '2' ORDER BY created_at DESC ".$page_query;
		$query_count = "SELECT COUNT(*) as count FROM game WHERE title LIKE '%$search%' AND game.deleted_at is null AND kind = '2' ORDER BY created_at DESC";
	}else if($option == 'search'){
		if($_GET['adrs'] != null || $_GET['sdate'] || $_GET['edate']){
			if($_GET['adrs']){
				$search_adrs = " AND adrs = ".$_GET['adrs'];
			}else{
				$search_adrs = "";
			}
			if($_GET['sdate'] != null && $_GET['edate'] != null){
				$search_date = " AND (DATE(game_date) BETWEEN '".$_GET['sdate']."' AND '".$_GET['edate']."')";
			}else if($_GET['sdate']){
				$search_date = " AND game_date >= '".$_GET['sdate']."'";
			}else if($_GET['edate']){
				$search_date = " AND game_date <= '".$_GET['edate']."'";
			}else{
				$search_date = "";
			}
			$query = "SELECT * FROM game WHERE deleted_at is null AND kind = '2'".$search_adrs.$search_date." ORDER BY created_at DESC ".$page_query;
			$query_count = "SELECT COUNT(*) as count FROM game WHERE deleted_at is null AND kind = '2'".$search_adrs.$search_date." ORDER BY created_at DESC";
		}else{
			$query = "SELECT * FROM game WHERE deleted_at is null AND kind = '2' ORDER BY created_at DESC ".$page_query;
			$query_count = "SELECT COUNT(*) as count FROM game WHERE deleted_at is null AND kind = '2' ORDER BY created_at DESC";
		}
	}
	$game_result = mysqli_query($conn, $query);
	$count_result = mysqli_query($conn, $query_count);
	$count_row = mysqli_fetch_array($count_result);
	$page_count = ceil($count_row['count']/$pn_count);
	if(!$option){
		$page_url = "game.html?game=agame&pn=";
	}else{
		$page_url = "game.html?game=agame&option=".$option."&search=".$search."&pn=";
	}
	if($pn == 1){
		$page_li = "<li class='page-item disabled'><a class='page-link' href='javascript:;'><i class='fas fa-angle-double-left'></i></a></li>";
	}else{
		$page_li = "<li class='page-item'><a class='page-link' href='".$page_url."1'><i class='fas fa-angle-double-left'></i></a></li>";
	}
	if($page_count < 5){
		for ($i=1; $i<=$page_count; $i++) {
			if($i != $pn){
				$page_li = $page_li."<li class='page-item'><a class='page-link' href='".$page_url."$i'>$i</a></li>";
			}else{
				$page_li = $page_li."<li class='page-item disabled'><a class='page-link' href='javascript:;'>$i</a></li>";
			}
		}
	}else{
		if($pn <= 3){
			for ($i=1; $i<=5; $i++) {
				if($i != $pn){
					$page_li = $page_li."<li class='page-item'><a class='page-link' href='".$page_url."$i'>$i</a></li>";
				}else{
					$page_li = $page_li."<li class='page-item disabled'><a class='page-link' href='javascript:;'>$i</a></li>";
				}
			}
		}else if($pn >= $page_count - 2){	
			for ($i=$page_count-4; $i<=$page_count; $i++) {
				if($i != $pn){
					$page_li = $page_li."<li class='page-item'><a class='page-link' href='".$page_url."$i'>$i</a></li>";
				}else{
					$page_li = $page_li."<li class='page-item disabled'><a class='page-link' href='javascript:;'>$i</a></li>";
				}
			}
		}else{
			for ($i=$pn -2; $i<=$pn+2; $i++) {
				if($i != $pn){
					$page_li = $page_li."<li class='page-item'><a class='page-link' href='".$page_url."$i'>$i</a></li>";
				}else{
					$page_li = $page_li."<li class='page-item disabled'><a class='page-link' href='javascript:;'>$i</a></li>";
				}
			}
		}
	}
	if($pn == $page_count){
		$page_li = $page_li."<li class='page-item disabled'><a class='page-link' href='javascript:;'><i class='fas fa-angle-double-right'></i></a></li>";
	}else{
		$page_li = $page_li."<li class='page-item'><a class='page-link' href='".$page_url."$page_count'><i class='fas fa-angle-double-right'></i></a></li>";
	}
?>
<html>
	<body>
		<section class="site-section">
			<div class="container">
				<div class="row">
					<div class="col-md-12">
						<h3 class="mb-5" style="vertical-align: middle;">일반 경기 (원정)</h3>
					</div>
					<div class="col-md-2">
						<a class="btn btn-primary" href="game.html?game=write&kind=agame" role="button">글쓰기</a>
					</div>
					<div class="col-md-8">
						<form action="game.html" class="form-inline element-animate" id="search-form" method="get">
							<button class="btn btn-outline-primary dropdown-toggle col-md-2" id="search_option" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">선택</button>
							<div class="dropdown-menu">
								<a class="dropdown-item" href="javascript:;" onclick="chang_option('팀이름','team')">팀이름</a>
								<a class="dropdown-item" href="javascript:;" onclick="chang_option('작성자','user')">작성자</a>
								<a class="dropdown-item" href="javascript:;" onclick="chang_option('제목','title')">제목</a>
								<div role="separator" class="dropdown-divider"></div>
								<a class="dropdown-item" href="javascript:;" onclick="chang_option('선택','')">취소</a>
							</div>
							<input type="hidden" name="game" value="agame">
							<input type="hidden" name="option" id="option" value="">
							<input type="text" style="border:1px solid #dee2e6; border-right:0px;" name="search" class="form-control form-control-block search-input col-md-8" id="autocomplete" placeholder="검색어를 입력해 주세요" required>
							<button type="submit" class="btn btn-primary col-md-2">검색</button>		
						</form>
					</div>
					<div class="col-md-2">
						<a class="btn btn-primary" href="javascript:;" role="button" onclick="game_search_option('agame')">상세 검색</a>
					</div>
				</div><br>
				<table class="table">
					<thead>
						<tr>
							<th scope="col-2" style="width:5%">번호</th>
							<th scope="col-2" style="width:30%">제목</th>
							<th scope="col-2" style="width:15%">팀 이름</th>
							<th scope="col-2" style="width:10%">작성자</th>
							<th scope="col-2" style="width:25%">작성일</th>
							<th scope="col-2" style="width:7%">조회수</th>
							<th scope="col-2" style="width:8%">마감</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<th scope="row" style="vertical-align: middle;">공지</th>
							<td colspan="2" style="vertical-align: middle;"><a href="notice.html?notice=agame" style="color:red;">※ 일반경기 (원정) 공지사항 필독</a></td>
							<td style="vertical-align: middle;">관리자(TRYOUT)</td>
							<td style="vertical-align: middle;">2019-01-01 00:00:00에 작성됨</td>
							<td colspan="2" style="vertical-align: middle;">-</td>
						</tr>
					<? 	if($game_result){
							while($game_row = mysqli_fetch_array($game_result)){
							$writer_no = $game_row['user'];
							$team_no = $game_row['team'];
							$game_no = $game_row['no'];
							$writer_result = mysqli_query($conn,"SELECT * FROM user where no='$writer_no'");
							$writer_row = mysqli_fetch_array($writer_result);
							$team_result = mysqli_query($conn,"SELECT * FROM team where no='$team_no'");
							$team_row = mysqli_fetch_array($team_result);
							$view_result = mysqli_query($conn,"SELECT * FROM game_view where game='$game_no'");
							$view_row = mysqli_fetch_array($view_result);
							$states_result = mysqli_query($conn,"SELECT * FROM game_states where game='$game_no'");
							$states_row = mysqli_fetch_array($states_result);
							if($game_row['adrs'] == 1){
								$adrs = '서울';
							}elseif($game_row['adrs'] == 2){
								$adrs = '경기';
							}elseif($game_row['adrs'] == 3){
								$adrs = '강원';
							}elseif($game_row['adrs'] == 4){
								$adrs = '충청';
							}elseif($game_row['adrs'] == 5){
								$adrs = '전라';
							}elseif($game_row['adrs'] == 6){
								$adrs = '경상';
							}elseif($game_row['adrs'] == 7){
								$adrs = '제주';
							}
							if($states_row['states'] == 1){
								$states = '진행중';
								$text_color = "#007bff";
							}elseif($states_row['states'] == 2){
								$states = '마감';
								$text_color = "red";
							}
							?>
						<tr>
							<th scope="row" style="vertical-align: middle;"><? echo $game_row['no'];?></th>
							<td style="vertical-align: middle;">
								<a href="game.html?game=read&no=<? echo $game_no?>"><? echo $game_row['title'];?></a>
							</td>							
							<td style="vertical-align: middle;">
								<a href="team.html?team=info&no=<? echo $team_no?>"><? echo $team_row['name'];?></a>
							</td>
							<td style="vertical-align: middle;"><a href="user.html?user=info&no=<? echo $writer_row['no'];?>"><? echo $writer_row['name'];?>(<? echo $writer_row['id'];?>)</a></td>
							<? if ($game_row['created_at'] == $game_row['updated_at']){?>
							<td style="vertical-align: middle;"><? echo $game_row['created_at'];?>에 작성됨</td>
							<? } else {?>
							<td style="vertical-align: middle;"><? echo $game_row['updated_at'];?>에 수정됨</td>
							<? } ?>
							<td style="vertical-align: middle;"><? echo $view_row['views'];?></td>
							<td style="vertical-align: middle;color:<? echo $text_color?>"><? echo $states;?></td>
						</tr>
						<? } 
					}?>
					</tbody>
				</table>
				<? if($page_count >= 1){?>
				<hr>
				<div class="row">
					<div class="col-md-4"></div>
					<div class="col-md-4">
						<nav aria-label="Page navigation example" style="padding-left:15px">
							<ul class="pagination">
								<?=$page_li;?>
							</ul>
						</nav>
					</div>
					<div class="col-md-4"></div>
				</div>
				<? } ?>
				<? 	mysqli_close($conn); ?>
			</div>
		</section>
	</body>
</html>