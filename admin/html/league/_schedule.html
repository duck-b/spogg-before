<!DOCTYPE HTML>
<?
	include "dbconn.php";
	if($_GET['year'] != null){
		$select_y = $_GET['year'];
	}else{
		$select_y = date('Y');
	}
	if($_GET['month'] != null){
		$select_m = $_GET['month'];
	}else{
		$select_m = date('m');
	}
	if($select_y == '2017'){
		$select_y_2017 = "selected";
	}else if($select_y == '2018'){
		$select_y_2018 = "selected";
	}else if($select_y == '2019'){
		$select_y_2019 = "selected";
	}
	if($select_m == '01'){
		$select_m_01 = "selected";
	}else if($select_m == '02'){
		$select_m_02 = "selected";
	}else if($select_m == '03'){
		$select_m_03 = "selected";
	}else if($select_m == '04'){
		$select_m_04 = "selected";
	}else if($select_m == '05'){
		$select_m_05 = "selected";
	}else if($select_m == '06'){
		$select_m_06 = "selected";
	}else if($select_m == '07'){
		$select_m_07 = "selected";
	}else if($select_m == '08'){
		$select_m_08 = "selected";
	}else if($select_m == '09'){
		$select_m_09 = "selected";
	}else if($select_m == '10'){
		$select_m_10 = "selected";
	}else if($select_m == '11'){
		$select_m_11 = "selected";
	}else if($select_m == '12'){
		$select_m_12 = "selected";
	}
	$play_list_query = "SELECT * FROM play WHERE league = '$no' AND play_datetime LIKE '%".$select_y."-".$select_m."%' ORDER BY play_datetime ASC";
	$play_list_result = mysqli_query($conn, $play_list_query);
	$i = 0;
	$play_list_tbody = "";
	while($play_list_row = mysqli_fetch_array($play_list_result)){
		$i++;
		if($pro_row){
			if(strtotime(date("Y-m-d H:i:s")) < strtotime($play_list_row['play_datetime'])){
				$play_name = $play_list_row['name']." <a href='league.html?league=page&no=".$no."&page=playedit&playno=".$play_list_row['no']."'> [수정]</a>";
			}else{
				$play_name = $play_list_row['name'];
			}
		}else{
			$play_name = $play_list_row['name'];
		}
		$play_date = date( 'n월 j일', strtotime($play_list_row['play_datetime']));
		$play_time = date( 'A H:i', strtotime($play_list_row['play_datetime']));
		$home_team_no = $play_list_row['home_team'];
		$home_team_result = mysqli_query($conn, "SELECT * FROM team WHERE no = '$home_team_no'");
		$home_team_row = mysqli_fetch_array($home_team_result);
		$away_team_no = $play_list_row['away_team'];
		$away_team_result = mysqli_query($conn, "SELECT * FROM team WHERE no = '$away_team_no'");
		$away_team_row = mysqli_fetch_array($away_team_result);
		if(mb_strlen($home_team_row['name'], 'UTF-8') <= 8){
			$home_name = $home_team_row['name'];
		}else{
			$home_name = mb_substr($home_team_row['name'], 0, 7, 'UTF-8')."...";
		}
		if(mb_strlen($away_team_row['name'], 'UTF-8') <= 8){
			$away_name = $away_team_row['name'];
		}else{
			$away_name = mb_substr($away_team_row['name'], 0, 7, 'UTF-8')."...";
		}
		if(strtotime(date("Y-m-d H:i:s")) < strtotime($play_list_row['play_datetime'])){
			$result_contents = "<th colspan='1' style='width:12.5%;vertical-align:middle'>-</th>
								<th colspan='1' style='width:12.5%'><a href='league.html?league=page&no=$no&page=playlist&play=".$play_list_row['no']."'>상세보기</a></th>";
		}else{
			$end_play_result = mysqli_query($conn,"SELECT COUNT(*) as count FROM play_end WHERE play='".$play_list_row['no']."'");
			$end_play_row = mysqli_fetch_array($end_play_result);
			if($end_play_row['count'] == 0){
				$start_play_result = mysqli_query($conn,"SELECT COUNT(*) as count FROM play_entry JOIN play_hit WHERE play_entry.play='".$play_list_row['no']."' AND play_hit.entry = play_entry.no");
				$start_play_row = mysqli_fetch_array($start_play_result);
				if($start_play_row['count'] == 0){
					$result_contents = "<th colspan='1' style='width:12.5%;vertical-align:middle'><a style='color:red'>경기취소</a></th>
										<th colspan='1' style='width:12.5%'><a href='league.html?league=page&no=$no&page=playlist&play=".$play_list_row['no']."'>상세보기</a></th>";
				}else{
					$result_contents = "<th colspan='1' style='width:12.5%;vertical-align:middle'><a style='color:green'>진행중</a></th>
										<th colspan='1' style='width:12.5%'><a href='league.html?league=page&no=$no&page=playlist&play=".$play_list_row['no']."'>상세보기</a></th>";
				}
			}else{
				$result_contents = "<th colspan='1' style='width:12.5%;vertical-align:middle'>경기종료</th>
									<th colspan='1' style='width:12.5%'><a href='league.html?league=page&no=$no&page=playlist&play=".$play_list_row['no']."'>상세보기</a></th>";
			}
		}
		$play_list_tbody = $play_list_tbody."<tr>
			<th rowspan='2' style='width:5%;vertical-align:middle;background-color:#ffffff'>".$i."</th>
			<th colspan='6' style='width:100%'>".$play_name."</th>
		</tr>
		<tr>
			<td colspan='1' style='width:15%;vertical-align:middle'>".$play_date."</td>
			<td colspan='1' style='width:15%;vertical-align:middle'>".$play_time."</td>
			<th colspan='1' style='width:20%;vertical-align:middle'><a href='javascript:;' onclick='new_page(".$home_team_no.")'>".$home_name."</a></th>
			<th colspan='1' style='width:20%;vertical-align:middle'><a href='javascript:;' onclick='new_page(".$away_team_no.")'>".$away_name."</a></th>
			".$result_contents."
		</tr>";
	}
	mysqli_close($conn);
?>
<html>
	<body>
		<form action="league.html" method="get">
			<input type="hidden" name="league" value="page">
			<input type="hidden" name="no" value="<? echo $no?>">
			<input type="hidden" name="page" value="schedule">
			<? if($pro_row){?>
			<div class="row form-group">
				<div class="col-md-4">
					<select class="custom-select" id="year" name="year">
						<option value="2017" <?=$select_y_2017?>>2017년</option>
						<option value="2018" <?=$select_y_2018?>>2018년</option>
						<option value="2019" <?=$select_y_2019?>>2019년</option>
					</select>
				</div>
				<div class="col-md-4">
					<select class="custom-select" id="month" name="month">
						<option value="01" <?=$select_m_01?>>1월</option>
						<option value="02" <?=$select_m_02?>>2월</option>
						<option value="03" <?=$select_m_03?>>3월</option>
						<option value="04" <?=$select_m_04?>>4월</option>
						<option value="05" <?=$select_m_05?>>5월</option>
						<option value="06" <?=$select_m_06?>>6월</option>
						<option value="07" <?=$select_m_07?>>7월</option>
						<option value="08" <?=$select_m_08?>>8월</option>
						<option value="09" <?=$select_m_09?>>9월</option>
						<option value="10" <?=$select_m_10?>>10월</option>
						<option value="11" <?=$select_m_11?>>11월</option>
						<option value="12" <?=$select_m_12?>>12월</option>
					</select>
				</div>
				<?if($pro_row['no'] == $_SESSION['user_no']){?>
				<div class="col-md-2">
					<input type="submit" class="btn btn-sm btn-primary" style="padding: 8px 30px" value="검색">
				</div>
				<div class="col-md-2">
					<a class="btn btn-sm btn-primary" style="padding: 8px 30px" href="league.html?league=page&no=<? echo $no;?>&page=playcreate">등록</a>
				</div>
				<? } else {?>
				<div class="col-md-4">
					<input type="submit" class="btn btn-sm btn-primary" style="padding: 8px 30px;width:100%" value="검색">
				</div>
				<? } ?>
			</div>
			<? } else {?>
			<div class="row form-group">
				<div class="col-md-5">
					<select class="custom-select" id="year" name="year">
						<option value="2017" <?=$select_y_2017?>>2017년</option>
						<option value="2018" <?=$select_y_2018?>>2018년</option>
						<option value="2019" <?=$select_y_2019?>>2019년</option>
					</select>
				</div>
				<div class="col-md-5">
					<select class="custom-select" id="month" name="month">
						<option value="01" <?=$select_m_01?>>1월</option>
						<option value="02" <?=$select_m_02?>>2월</option>
						<option value="03" <?=$select_m_03?>>3월</option>
						<option value="04" <?=$select_m_04?>>4월</option>
						<option value="05" <?=$select_m_05?>>5월</option>
						<option value="06" <?=$select_m_06?>>6월</option>
						<option value="07" <?=$select_m_07?>>7월</option>
						<option value="08" <?=$select_m_08?>>8월</option>
						<option value="09" <?=$select_m_09?>>9월</option>
						<option value="10" <?=$select_m_10?>>10월</option>
						<option value="11" <?=$select_m_11?>>11월</option>
						<option value="12" <?=$select_m_12?>>12월</option>
					</select>
				</div>
				<div class="col-md-2">
					<input type="submit" class="btn btn-sm btn-primary" style="padding: 8px 30px" value="검색">
				</div>
			</div>
			<? } ?>
		</form>
		<hr>
		<? if($play_list_tbody){?>
		<table class="table table-striped table-bordered" style="text-align:center;font-size:80%">
			<thead>
				<tr>
					<th colspan="1" style="width:5%">No</th>
					<th colspan="2" style="width:30%">경기 시간</th>
					<th colspan="1" style="width:20%">Home</th>
					<th colspan="1" style="width:20%">Away</th>
					<th colspan="2" style="width:25%">결과</th>
				</tr>
			</thead>
			<tbody>
				<?=$play_list_tbody?>
			</tbody>
		</table>
		<? } else {?>
			<p style="text-align:center">경기가 없습니다</p>
		<? } ?>
	</body>
</html>