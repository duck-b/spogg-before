<!DOCTYPE HTML>
<?
	if($user_no){
		$new_data_id = "id='new_data' style='display:none'";
		$new_data_action = "RecordInsertProc.php";
		$new_data_submit = "Save & Analysis";
		include "dbconn.php";
		//1 start
		$record_list_result = mysqli_query($conn, "SELECT * FROM data_before_pic WHERE player_no = '$player_no'");
		$data_list = "";
		while($record_list_row = mysqli_fetch_array($record_list_result)){
			$at_game = $record_list_row['at_game'];
			$inning = $record_list_row['inning'];
			$er = $record_list_row['er'];
			$hit = $record_list_row['hit1'] + $record_list_row['hit2'] + $record_list_row['hit3'] + $record_list_row['hr'];
			$b4 = $record_list_row['b4'] + $record_list_row['hbp'];
			$so = $record_list_row['so'];
			if($at_game != null && $er != null && $hit != null && $b4 != null && $so != null && $inning != null){
				if($at_game == 0 || $inning == 0){
					$data_list = $data_list."<div class='col-3 col-6-xsmall'>
						<a href='javascript:;' class='button fit disabled'>".$record_list_row['league_name']."</a>
					</div>";
				}else{
					$data_list = $data_list."<div class='col-3 col-6-xsmall'>
						<a href='analy.html?analy_no=".$analy_no."&data_no=".$record_list_row['no']."' class='button fit'>".$record_list_row['league_name']."</a>
					</div>";
				}
			}else{
				$data_list = $data_list."<div class='col-3 col-6-xsmall'>
					<a href='javascript:;' class='button fit disabled'>".$record_list_row['league_name']."</a>
				</div>";
			}
		}
		//1 end
		$data_list = $data_list."<div class='col-3 col-6-xsmall'>
			<a href='javascript:;' class='button primary fit' onclick='open_new_data()'>New Data</a>
		</div>";
		mysqli_close($conn);
	}else{
		if($_POST['analy']){
			$new_data_id = "id='new_data' style='display:none'";
		}else{
			$new_data_id = "";
		}
		$new_data_action = "analy.html?analy_no=".$analy_no;
		$new_data_submit = "Analysis";
	}
	//2 start
	if($_GET['data_no'] != null || $_POST['analy'] != null){
		if($_POST['analy']){
			$player_no = 0;
			$league_name = $_POST['league_name'];
			$team_name = $_POST['team_name'];
			$at_game = $_POST['at_game'];
			$inning = $_POST['inning']*3 + $_POST['inning_2'];
			$play_win = $_POST['play_win'];
			$play_lose = $_POST['play_lose'];
			$play_save = $_POST['play_save'];
			$play_hold = $_POST['play_hold'];
			$pitcher_count = $_POST['pitcher_count'];
			$so = $_POST['so'];
			$hit1 = $_POST['hit'] - $_POST['hit2'] - $_POST['hit3'] - $_POST['hr'];
			$hit2 = $_POST['hit2'];
			$hit3 = $_POST['hit3'];
			$hr = $_POST['hr'];
			$er = $_POST['er'];
			$b4 = $_POST['b4'] - $_POST['hbp'];
			$hbp = $_POST['hbp'];
			$at_play = $_POST['at_play'];
			$at_bat = $_POST['at_play'] - $_POST['b4'] - $_POST['hbp'] - $_POST['sh'] - $_POST['sf'];
			$sf = $_POST['sf'];
			$sh = $_POST['sh'];
			if($at_game == 0 || $inning == 0){
				// 기록 잘못 입력
				$analy = 3;
				$new_data_id = "";
				$error_message = "<b style='color:red'>기록을 잘 못 입력하였습니다</b>";
			}else{
				include "dbconn.php";
				mysqli_query($conn,"INSERT INTO data_before_pic (player_no, team_name, league_name, at_game, inning, play_win, play_lose, play_save, play_hold, pitcher_count, so, hit1, hit2, hit3, hr, er, b4, hbp, at_play, at_bat, sh, sf) VALUES ('$player_no', '$team_name', '$league_name', '$at_game', '$inning', '$play_win', '$play_lose', '$play_save', '$play_hold', '$pitcher_count', '$so', '$hit1', '$hit2', '$hit3', '$hr', '$er', '$b4', '$hbp', '$at_play', '$at_bat', '$sh', '$sf')");
				mysqli_close($conn);
				$data_no_result = mysqli_query($conn, "SELECT MAX(no) as maxno FROM data_before_pic WHERE player_no = '0'");
				$data_no_row = mysqli_fetch_array($data_no_result);
				$data_no = $data_no_row['maxno'];
				$analy = 1;
			}
		}else{
			include "dbconn.php";
			$data_no = $_GET['data_no'];
			$page = $page."&data_no=".$data_no;
			$record_result = mysqli_query($conn, "SELECT * FROM data_before_pic WHERE no = '$data_no'");
			$record_row = mysqli_fetch_array($record_result);
			mysqli_close($conn);
			$league_name = $record_row['league_name'];
			$team_name = $record_row['team_name'];
			$at_game = $record_row['at_game'];
			$inning = $record_row['inning'];
			$play_win = $record_row['play_win'];
			$play_lose = $record_row['play_lose'];
			$play_save = $record_row['play_save'];
			$play_hold = $record_row['play_hold'];
			$pitcher_count = $record_row['pitcher_count'];
			$so = $record_row['so'];	
			$hit1 = $record_row['hit1'];
			$hit2 = $record_row['hit2'];
			$hit3 = $record_row['hit3'];
			$hr = $record_row['hr'];
			$er = $record_row['er'];
			$b4 = $record_row['b4'];
			$hbp = $record_row['hbp'];
			$at_play = $record_row['at_play'];
			$at_bat = $record_row['at_bat'];
			$sf = $record_row['sf'];
			$sh = $record_row['sh'];
			if($at_game != null && $er != null && $hit1 != null && $b4 != null && $so != null && $inning != null){
				if($at_game == 0 || $inning == 0){
					$analy = 2;
				}else{
					$analy = 1;
				}
			}else{
				$analy = 2;
			}
		}
	}
	// analysis
	if($analy == 1){
		//hat = ERA + GW + HI + BBI + SOI
		$hit = $hit1 + $hit2 + $hit3 + $hr;
		
		$ERAdata = ($er * 7) / ($inning/3);
		if($play_win == 0){
			$GWdata = 21.5;
		}else{
			$GWdata = $at_game/$play_win;
		}
		$HIdata = ($hit*7)/($inning/3);
		$BBIdata = (($b4+$hbp)*7)/($inning/3);
		$SOIdata = ($so*7)/($inning/3);
		
		$AVGhat = number_format(0.7512519-0.0280112*$ERAdata+0.0038713*$GWdata-0.0018773*$HIdata+0.0014543*$BBIdata+0.0041861*$SOIdata,3);
		$OBPhat = number_format(0.8013496-0.0190051*$ERAdata+0.0035794*$GWdata-0.0055535*$HIdata+0.0001217*$BBIdata+0.0026364*$SOIdata,3);
		$BBKhat = number_format(2.79751-0.08164*$ERAdata+0.04745*$GWdata-0.07018*$HIdata-0.01018*$BBIdata+0.09825*$SOIdata,2);
		$HGhat = number_format(2.338195-0.107168*$ERAdata+0.001860*$GWdata+0.001860*$HIdata+0.015512*$BBIdata+0.012359*$SOIdata,1);
		$RGhat = number_format(1.869501-0.078947*$ERAdata+0.012354*$GWdata-0.004785*$HIdata+0.011682*$BBIdata+0.009039*$SOIdata,1);
		$RBIGhat = number_format(2.108847-0.044920*$ERAdata+0.015528*$GWdata-0.027068*$HIdata-0.005359*$BBIdata+0.002007*$SOIdata,1);
		$SBGhat = number_format(1.814841-0.075332*$ERAdata+0.010526*$GWdata+0.007193*$HIdata+0.011007*$BBIdata+0.015028*$SOIdata,1);
	//2 end
		// 기록 요약
		$b4 = $b4 + $hbp;
		if($sh == ""){
			$sh = "-";
		}
		if($sf == ""){
			$sf = "-";
		}
		if($hbp == ""){
			$hbp = "-";
		}
		if($hit2 == ""){
			$hit2 = "-";
		}
		if($hit3 == ""){
			$hit3 = "-";
		}
		if($at_play == ""){
			$at_play = "-";
		}
		
		if($pitcher_count == ""){
			$pitcher_count = "-";
			$pcg = "-";
			$pcin = "-";
		}else{
			$pitcher_count = $pitcher_count;
			$pcg = number_format($pitcher_count/$at_game,1);
			$pcin = number_format($pitcher_count/($inning/3),1);
		}
		if($inning != 0){
			$era = number_format(($er * 7)/($inning/3),2);
			$whip = number_format(($hit1 + $hit2 + $hit3 + $hr + $b4 + $hbp)/($inning/3),2);
		}else{
			$era = "-";
			$whip = "-";
		}
		$h_inning = ($inning - ($inning % 3)) / 3;
		if($inning % 3 == 0){
			$f_inning = "";
		}else if($inning % 3 == 1){
			$f_inning = "⅓";
		}else if($inning % 3 == 2){
			$f_inning = "⅔";
		}
		if($play_win + $play_lose != 0){
			$wptc = number_format(($play_win)/($play_win + $play_lose),3);
		}else{
			$wptc = "-";
		}
		if($b4 + $hbp != 0){
			$kbb = number_format($so/($b4 + $hbp),2);
		}else{
			$kbb = "-";
		}
		if($at_bat != 0){
			$avg = number_format(($hit)/($at_bat),3);
		}else{
			$avg = "-";
		}
		$pic_table = "<table class='alt' style='font-size:80%;margin-top:10px'>
						<tbody>
							<tr>
								<td colspan='5' style='padding:0px;text-align:center;vertical-align:middle'>기록 요약 (".$league_name." : ".$team_name.")</td>
							</tr>
							<tr>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='경기 수'>G</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='평균자책점'>ERA</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='승리'>W</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='패배'>L</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='세이브'>SV</td>	
							</tr>
							<tr>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$at_game."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$era."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$play_win."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$play_lose."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$play_save."</td>
							</tr>
							<tr>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='홀드'>HLD</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='승률'>WPCT</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='이닝'>IP</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='투구수'>NC</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='피안타'>H</td>
							</tr>
							<tr>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$play_hold."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$wptc."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$h_inning.$f_inning."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$pitcher_count."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$hit."</td>
							</tr>
							<tr>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='피2루타'>2B</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='피3루타'>3B</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='피홈런'>HR</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='볼넷(사사구 포함)'>BB</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='사사구'>HBP</td>
							</tr>
							<tr>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$hit2."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$hit3."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$hr."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$b4."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$hbp."</td>
							</tr>
							<tr>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='탈삼진'>SO</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='실점 또는 자책점'>R</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='희생번트'>SAC</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='희생플라이'>SF</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='타자수'>TBF</td>
							</tr>
							<tr>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$so."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$er."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$sh."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$sf."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$at_play."</td>
							</tr>
							<tr>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='삼진/볼넷'>K/BB</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='경기당 투구수'>P/G</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='이닝당 투구수'>P/IP</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='피안타율'>AVG</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='이닝당 출루 허용율'>WHIP</td>
							</tr>
							<tr>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$kbb."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$pcg."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$pcin."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle%'>".$avg."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$whip."</td>
							</tr>
						</tbody>
					</table>";
	}
	if($_GET['re'] == 1){
		$new_data_id = "";
	}
	if($data_no){
		$new_data_id = "id='new_data' style='display:none'";
	}
?>
<html>
	<body>
		<?if($user_no){?>
		<hr>
		<h3>저장된 기록</h3>
		<div class="row">
			<?=$data_list?>
		</div>
		<? } ?>
		<div <?=$new_data_id?>>
			<hr>
			<h3>새로운 기록 <b style="font-size:60%">(*은 필수 입력)</b></h3>
			<?=$error_message?>
			<form method="post" action="<?=$new_data_action?>" method="post">
				<div class="row gtr-uniform">
					<!-- 3 start -->
					<div class="col-3 col-6-xsmall">
						<input type="text" name="league_name" id="league_name" placeholder="리그 이름">
					</div>
					<div class="col-3 col-6-xsmall">
						<input type="text" name="team_name" id="team_name" placeholder="팀 이름">
					</div>
					<div class="col-3 col-6-xsmall">
						<input type="text" name="at_game" id="at_game" placeholder="경기 수 *" pattern="\d{1,3}" required>
					</div>
					<div class="col-2 col-2-xsmall">
						<input type="text" name="inning" id="inning" placeholder="이닝 *" pattern="\d{1,3}" required>
					</div>
					<div class="col-1 col-4-xsmall">
						<select class="custom-select" id="inning_2" name="inning_2">
							<option value="0" selected>0</option>
							<option value="1" style="font-size:130%">⅓</option>
							<option value="2" style="font-size:130%">⅔</option>
						</select>
					</div>
					<div class="col-3 col-6-xsmall">
						<input type="text" name="pitcher_count" id="pitcher_count" placeholder="투구수" pattern="\d{1,3}">
					</div>
					<div class="col-3 col-6-xsmall">
						<input type="text" name="play_win" id="play_win" placeholder="승리 *" pattern="\d{1,3}" required>
					</div>
					<div class="col-3 col-6-xsmall">
						<input type="text" name="play_lose" id="play_lose" placeholder="패배" pattern="\d{1,3}">
					</div>
					<div class="col-3 col-6-xsmall">
						<input type="text" name="play_save" id="play_save" placeholder="세이브" pattern="\d{1,3}">
					</div>
					<div class="col-3 col-6-xsmall">
						<input type="text" name="play_hold" id="play_hold" placeholder="홀드" pattern="\d{1,3}">
					</div>
					<div class="col-3 col-6-xsmall">
						<input type="text" name="hit" id="hit" placeholder="피안타 * [1H,2H,3H,HR 포함]" pattern="\d{1,3}" required>
					</div>
					<div class="col-3 col-6-xsmall">
						<input type="text" name="hr" id="hr" placeholder="피홈런" pattern="\d{1,3}">
					</div>
					<div class="col-3 col-6-xsmall">
						<input type="text" name="hit2" id="hit2" placeholder="2루타" pattern="\d{1,3}">
					</div>
					<div class="col-3 col-6-xsmall">
						<input type="text" name="hit3" id="hit3" placeholder="3루타" pattern="\d{1,3}">
					</div>
					<div class="col-3 col-6-xsmall">
						<input type="text" name="so" id="so" placeholder="탈삼진 *" pattern="\d{1,3}" required>
					</div>
					<div class="col-3 col-6-xsmall">
						<input type="text" name="b4" id="b4" placeholder="볼넷 * [사사구 포함]" pattern="\d{1,3}" required>
					</div>
					<div class="col-3 col-6-xsmall">
						<input type="text" name="hbp" id="hbp" placeholder="사사구" pattern="\d{1,3}">
					</div>
					<div class="col-3 col-6-xsmall">
						<input type="text" name="er" id="er" placeholder="실점 *" pattern="\d{1,3}" required>
					</div>
					<div class="col-3 col-6-xsmall">
						<input type="text" name="at_play" id="at_play" placeholder="상대 타자수" pattern="\d{1,3}">
					</div>
					<div class="col-3 col-6-xsmall">
						<input type="text" name="sf" id="sf" placeholder="희생타" pattern="\d{1,3}">
					</div>
					<div class="col-3 col-6-xsmall">
						<input type="text" name="sh" id="sh" placeholder="희생번트" pattern="\d{1,3}">
					</div>
					<!-- 3 end -->
					<input type="hidden" value="T" name="analy">
					<input type="hidden" value="pic" name="pos">
					<input type="hidden" value="<?=$analy_no?>" name="analy_no">
					<div class="col-12" style="text-align:center">
						<input type="submit" value="<?=$new_data_submit?>" class="primary">
					</div>
				</div>
			</form>
		</div>
		<?if($analy == 1){?>
		<hr>
		<!-- 4 start -->
		<table class="alt">
			<tbody style="text-align:center">
				<tr>
					<td colspan="2" style="width:100%">분석 결과</td>
				</tr>
				<tr>
					<td style="width:40%">예측 기록</td>
					<td style="width:60%">결과</td>
				</tr>
				<tr>
					<td style="width:40%">AVG</td>
					<td style="width:60%;vertical-align:middle"><?=$AVGhat?></td>
				</tr>
				<tr>
					<td style="width:40%">OBP</td>
					<td style="width:60%;vertical-align:middle"><?=$OBPhat?></td>
				</tr>
				<tr>
					<td style="width:40%">BB/K</td>
					<td style="width:60%;vertical-align:middle"><?=$BBKhat?></td>
				</tr>
				<tr>
					<td style="width:40%">H/G</td>
					<td style="width:60%;vertical-align:middle"><?=$HGhat?></td>
				</tr>
				<tr>
					<td style="width:40%">SB/G</td>
					<td style="width:60%;vertical-align:middle"><?=$SBGhat?></td>
				</tr>
				<tr>
					<td style="width:40%">R/G</td>
					<td style="width:60%;vertical-align:middle"><?=$RGhat?></td>
				</tr>
				<tr>
					<td style="width:40%">RBI/G</td>
					<td style="width:60%;vertical-align:middle"><?=$RBIGhat?></td>
				</tr>
			</tbody>
		</table>
		<div class="row" style="text-align:center">
			<div class="col-6 col-12-xsmall">
				<h3>예측 기록</h3>
				<p>AVG : 타율</p>
				<p>OBP : 출루율</p>
				<p>BB/K : 삼진 대비 볼넷 비율</p>
				<p>H/G : 경기당 안타</p>
				<p>SB/G : 경기당 도루</p>
				<p>R/G : 경기당 득점</p>
				<p>RBI/G : 경기당 타점</p>
			</div>
			<div class="col-6 col-12-xsmall">
				설명 2
			</div>
		</div>
		<?=$pic_table?>
		<!-- 4 end -->
		<hr>
		<!--<span class="image main"><img src="images/pic13.jpg" alt="" /></span>-->
		<? } ?>
	</body>
</html>