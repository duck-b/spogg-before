<!DOCTYPE HTML>
<?
	if($_POST['team'] && $_POST['year']){
		include "dbconn.php";
		$query = "SELECT data_before_hit.no, data_before_hit.team_name, data_before_hit.league_name, user.name FROM data_before_hit JOIN user JOIN player WHERE (data_before_hit.no BETWEEN 4 AND 257) AND data_before_hit.team_name LIKE '%".$_POST['team']."%' AND data_before_hit.league_name LIKE '".$_POST['year']."%' AND player.no = data_before_hit.player_no AND player.user = user.no";
		$record_list_result = mysqli_query($conn, $query);
		mysqli_close($conn);
		$data_list = "";
		while($record_list_row = mysqli_fetch_array($record_list_result)){
			$data_list = $data_list."<div class='col-3 col-6-xsmall'>
						<a href='analy.html?analy_no=".$analy_no."&data_no=".$record_list_row['no']."' class='button fit'>".$record_list_row['name']."</a>
					</div>";
			$team_league ="(".$record_list_row['league_name']." : ".$record_list_row['team_name'].")";
		}
	}
	if($_GET['data_no']>=4 && $_GET['data_no']<=257){
		$new_data_id = "id='new_data' style='display:none'";
		include "dbconn.php";
		$data_no = $_GET['data_no'];
		$page = $page."&data_no=".$data_no;
		$record_result = mysqli_query($conn, "SELECT * FROM data_before_hit WHERE no = '$data_no'");
		$record_row = mysqli_fetch_array($record_result);
		mysqli_close($conn);
		$league_name = $record_row['league_name'];
		$team_name = $record_row['team_name'];
		$at_game = $record_row['at_game'];
		$at_play = $record_row['at_play'];
		$at_bat = $record_row['at_bat'];
		$hit1 = $record_row['hit1'];
		$hit2 = $record_row['hit2'];
		$hit3 = $record_row['hit3'];
		$hr = $record_row['hr'];
		$b4 = $record_row['b4'];
		$hbp = $record_row['hbp'];
		$sb = $record_row['sb'];
		$sf = $record_row['sf'];
		$sh = $record_row['sh'];
		$so = $record_row['so'];
		$rs = $record_row['rs'];
		$rbi = $record_row['rbi'];
		$analy = 1;
	}
// analysis
	if($analy == 1){
		$AT_BATdata = 8.67563*(($at_bat - 462.5093) / 54.88574) + 33.47981;
		$HIT1data = 4.992103*(($hit1 - 96.37918) / 19.91168) + 12.75481;
		$HIT2data = 2.625405*(($hit2 - 26.10781) / 7.323004) + 1.780769;
		$HIT3data = 0.7691055*(($hit3 - 2.468401) / 2.646443) + 0.3326923;
		$HRdata = 0.9940619*(($hr - 17.75093) / 10.84909) + 0.4721154;
		$BBdata = 3.350676*((($b4 + $hbp) - 50.05948) / 17.25436) + 6.950962;
		$SFdata = 0.8092592*(($sf - 4.788104) / 2.587947) + 0.5774038;
		
		if($AT_BATdata >= 81){
			$AT_BATdata = 81;
		}else if($AT_BATdata <= 16){
			$AT_BATdata = 16;
		}
		if($HIT1data >= 31){
			$HIT1data = 31;
		}else if($HIT1data <= 0){
			$HIT1data = 0;
		}
		if($HIT2data >= 13){
			$HIT2data = 13;
		}else if($HIT2data <= 0){
			$HIT2data = 0;
		}
		if($HIT3data >= 7){
			$HIT3data = 7;
		}else if($HIT3data <= 0){
			$HIT3data = 0;
		}
		if($HRdata >= 12){
			$HRdata = 12;
		}else if($HRdata <= 0){
			$HRdata = 0;
		}
		if($BBdata >= 20){
			$BBdata = 20;
		}else if($BBdata <= 0){
			$BBdata = 0;
		}
		if($SFdata >= 5){
			$SFdata = 5;
		}else if($SFdata <= 0){
			$SFdata = 0;
		}
		$AVGhat = round(($HIT1data + $HIT2data + $HIT3data + $HRdata) / $AT_BATdata,3);
		$ISOhat = round(($HIT2data + $HIT3data*2 + $HRdata*3) / $AT_BATdata,3);
		$OBPhat = round(($HIT1data + $HIT2data + $HIT3data + $HRdata + $BBdata) / ($AT_BATdata + $BBdata + $SFdata),3);
		$SLGhat = round(($HIT1data + $HIT2data*2 + $HIT3data*3 + $HRdata*4) / $AT_BATdata,3);
		$OPShat = round((($HIT1data + $HIT2data + $HIT3data + $HRdata + $BBdata) / ($AT_BATdata + $BBdata + $SFdata)) + (($HIT1data + $HIT2data*2 + $HIT3data*3 + $HRdata*4) / $AT_BATdata),3);
		/*
		$AVGdata = ($hit1 + $hit2 + $hit3 + $hr) / $at_bat;
		$ISOdata = ($hit2 + $hit3*2 + $hr*3) / $at_bat;
		$OBPdata = ($hit1 + $hit2 + $hit3 + $hr + $b4 + $hbp) / ($at_bat + $b4 + $hbp + $sf);
		$SLGdata = ($hit1 + $hit2*2 + $hit3*3 + $hr*4) / $at_bat;
		$OPSdata = (($hit1 + $hit2 + $hit3 + $hr + $b4 + $hbp) / ($at_bat + $b4 + $hbp + $sf)) + (($hit1 + $hit2*2 + $hit3*3 + $hr*4) / $at_bat);
		
		$AVGhatUP = round((0.1244859*(($AVGdata - 0.3077732) / 0.02682761) + 0.454474) + 1.28*0.1244859,3);
		$ISOhatUP = round((0.1239554*(($ISOdata - 0.1816803) / 0.06868163) + 0.1053389) + 1.28*0.1239554,3);
		$OBPhatUP = round((0.1069091*(($OBPdata - 0.3714164) / 0.03328906) + 0.5423115) + 1.28*0.1069091,3);
		$SLGhatUP = round((0.2050919*(($SLGdata - 0.4894535) / 0.0783893) + 0.5598245) + 1.28*0.2050919,3);
		$OPShatUP = round((0.2913017*(($OPSdata - 0.8608699) / 0.1009305) + 1.102136) + 1.28*0.2913017,3);
		$AVGhatDown = round((0.1244859*(($AVGdata - 0.3077732) / 0.02682761) + 0.454474) - 1.28*0.1244859,3);
		$ISOhatDown = round((0.1239554*(($ISOdata - 0.1816803) / 0.06868163) + 0.1053389) - 1.28*0.1239554,3);
		$OBPhatDown = round((0.1069091*(($OBPdata - 0.3714164) / 0.03328906) + 0.5423115) - 1.28*0.1069091,3);
		$SLGhatDown = round((0.2050919*(($SLGdata - 0.4894535) / 0.0783893) + 0.5598245) - 1.28*0.2050919,3);
		$OPShatDown = round((0.2913017*(($OPSdata - 0.8608699) / 0.1009305) + 1.102136) - 1.28*0.2913017,3);
		
		if($AVGhatUP >= 0.792){
			$AVGhatUP = 0.792;
		}
		if($AVGhatDown <= 0.13){
			$AVGhatDown = 0.13;
		}
		if($ISOhatUP >= 0.84){
			$ISOhatUP = 0.84;
		}
		if($ISOhatDown <= 0){
			$ISOhatDown = 0;
		}
		if($OBPhatUP >= 0.868){
			$OBPhatUP = 0.868;
		}
		if($OBPhatDown <= 0.233){
			$OBPhatDown = 0.233;
		}
		if($SLGhatUP >= 1.54){
			$SLGhatUP = 1.54;
		}
		if($SLGhatDown < 0.13){
			$SLGhatDown = 0.13;
		}
		if($OPShatUP >= 2.254){
			$OPShatUP = 2.254;
		}
		if($OPShatDown <= 0.449){
			$OPShatDown = 0.449;
		}
		*/
		// 기록 요약
		if($sh == ""){
			$sh = "-";
		}
		if($sf == ""){
			$sf = "-";
		}
		if($hbp == ""){
			$hbp = "-";
		}
		if($at_bat != 0){
			$avg = number_format(($hit1 + $hit2 + $hit3 + $hr)/$at_bat,3);
			$slg = number_format(($hit1*1 + $hit2*2 + $hit3*3 + $hr*4)/$at_bat,3);
			$iso = number_format(($hit2*1 + $hit3*2 + $hr*3)/$at_bat,3);
		}else{
			$avg = "-";
			$slg = "-";
			$iso = "-";
		}
		if($at_bat + $b4 + $hbp + $sf != 0){
			$obp = number_format(($hit1 + $hit2 + $hit3 + $hr + $b4 + $hbp)/($at_bat + $b4 + $hbp + $sf),3);
		}else{
			$obp = "-";
		}
		if($slg != "-" && $obp != "-"){
			$ops = number_format($slg + $obp,3);
			$gpa = number_format((1.8*$slg + $obp)/4,3);
		}else{
			$ops = "-";
			$gpa = "-";
		}
		if($so != 0){
			$b4so = number_format($b4/$so,2);
		}else{
			$b4so = "-";
		}
		if($hr != 0){
			$abhr = number_format($at_bat/$hr,1);
		}else{
			$abhr = "-";
		}
		$hit_table = "<table class='alt' style='font-size:80%;margin-top:10px'>
						<tbody>
							<tr>
								<td colspan='5' style='padding:0px;text-align:center;vertical-align:middle'>기록 요약 (".$league_name." : ".$team_name.")</td>
							</tr>
							<tr>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='경기 수'>G</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='타석'>PA</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='타수'>AB</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='타율'>AVG</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='타점'>RBI</td>
								
							</tr>
							<tr>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$at_game."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$at_play."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$at_bat."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$avg."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$rbi."</td>
							</tr>
							<tr>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='득점'>R</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='안타'>H</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='2루타'>2B</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='3루타'>3B</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='홈런'>HR</td>
							</tr>
							<tr>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$rs."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".($hit1 + $hit2 + $hit3 + $hr)."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$hit2."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$hit3."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$hr."</td>
							</tr>
							<tr>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='루타'>TB</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='희생번트'>SAC</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='희생플라이'>SF</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='볼넷(사사구 포함)'>BB</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='사사구'>HBP</td>
							</tr>
							<tr>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".($hit1*1 + $hit2*2 + $hit3*3 + $hr*4)."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$sh."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$sf."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".($b4 + $hbp)."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$hbp."</td>
							</tr>
							<tr>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='삼진'>SO</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='도루'>SB</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='장타'>XBH</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='장타율'>SLG</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='출루율'>OBP</td>
							</tr>
							<tr>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$so."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$sb."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".($hit2 + $hit3 + $hr)."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$slg."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$obp."</td>
							</tr>
							<tr>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='출루율 + 장타율'>OPS</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='볼넷/삼진'>BB/K</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='홈런당 평균타수'>AB/HR</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='순장타율'>ISO</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle;width:10%' title='(1.8*출루율+장타율)/4'>GPA</td>
							</tr>
							<tr>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$ops."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$b4so."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$abhr."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle%'>".$iso."</td>
								<td colspan='1' style='padding:0px;text-align:center;vertical-align:middle'>".$gpa."</td>
							</tr>
						</tbody>
					</table>";
	}
	if($_GET['re'] == 1){
		$new_data_id = "";
	}
?>
<html>
	<body>
		<?if(!$data_list){?>	
		<div <?=$new_data_id?>>
			<hr>
			<h3>기록 검색<b style="font-size:60%"></b></h3>
			<form method="post" action="analy.html?analy_no=<?=$analy_no?>" method="post">
				<div class="row gtr-uniform">
					<div class="col-6 col-12-xsmall">
						<select class="custom-select" id="team" name="team">
							<option value="0" selected>팀을 선택해주세요</option>
							<option value="kia">KIA 타이거즈</option>
							<option value="kt">KT 위즈</option>
							<option value="lg">LG 트윈스</option>
							<option value="nc">NC 다이노스</option>
							<option value="sk">SK 와이번스</option>
							<option value="넥센">넥센 히어로즈</option>
							<option value="두산">두산 베어스</option>
							<option value="롯데">롯데 자이언츠</option>
							<option value="삼성">삼성 라이온즈</option>
							<option value="한화">한화 이글스</option>
						</select>
					</div>
					<div class="col-6 col-12-xsmall">
						<select class="custom-select" id="year" name="year">
							<option value="0" selected>시즌을 선택해주세요</option>
							<option value="2018">2018 KBO 프로리그</option>
							<option value="2017">2017 KBO 프로리그</option>
							<option value="2016">2016 KBO 프로리그</option>
							<option value="2015">2015 KBO 프로리그</option>
							<option value="2014">2014 KBO 프로리그</option>
						</select>
					</div>
					<div class="col-12" style="text-align:center">
						<input type="submit" value="검색" style="width:30%" class="primary">
					</div>
				</div>
			</form>
		</div>
		<? } else {?>
		<hr>
		<h3>선수 선택<b style="font-size:60%"><?echo $team_league?></b></h3>
		<div class="row">
			<?=$data_list?>
		</div>
		<? } ?>
		<?if($analy == 1){?>
		<hr>
		<table class="alt">
			<tbody style="text-align:center">
				<tr>
					<td colspan="2" style="width:100%">분석 결과</td>
				</tr>
				<tr>
					<td style="width:40%">예측 기록</td>
					<td style="width:60%">결과</td>
				</tr>
				<!--
				<tr>
					<td style="width:40%">AVG</td>
					<td style="width:60%;vertical-align:middle"><?=$AVGhatDown?> ~ <?=$AVGhatUP?></td>
				</tr>
				<tr>
					<td style="width:40%">ISO</td>
					<td style="width:60%;vertical-align:middle"><?=$ISOhatDown?> ~ <?=$ISOhatUP?></td>
				</tr>
				<tr>
					<td style="width:40%">OBP</td>
					<td style="width:60%;vertical-align:middle"><?=$OBPhatDown?> ~ <?=$OBPhatUP?></td>
				</tr>
				<tr>
					<td style="width:40%">SLG</td>
					<td style="width:60%;vertical-align:middle"><?=$SLGhatDown?> ~ <?=$SLGhatUP?></td>
				</tr>
				<tr>
					<td style="width:40%">OPS</td>
					<td style="width:60%;vertical-align:middle"><?=$OPShatDown?> ~ <?=$OPShatUP?></td>
				</tr>
				-->
				<tr>
					<td style="width:40%">AVG</td>
					<td style="width:60%;vertical-align:middle"><?=$AVGhat?></td>
				</tr>
				<tr>
					<td style="width:40%">ISO</td>
					<td style="width:60%;vertical-align:middle"><?=$ISOhat?></td>
				</tr>
				<tr>
					<td style="width:40%">OBP</td>
					<td style="width:60%;vertical-align:middle"><?=$OBPhat?></td>
				</tr>
				<tr>
					<td style="width:40%">SLG</td>
					<td style="width:60%;vertical-align:middle"><?=$SLGhat?></td>
				</tr>
				<tr>
					<td style="width:40%">OPS</td>
					<td style="width:60%;vertical-align:middle"><?=$OPShat?></td>
				</tr>
			</tbody>
		</table>
		<div class="row" style="text-align:center">
			<div class="col-6 col-12-xsmall">
				<table class="alt">
					<tbody style="text-align:center">
						<tr>
							<td colspan="5" style="width:100%">프로 야구 평균</td>
						</tr>
						<tr>
							<td style="width:40%">AVG</td>
							<td style="width:60%;vertical-align:middle">0.308</td>
						</tr>
						<tr>
							<td style="width:40%">ISO</td>
							<td style="width:60%;vertical-align:middle">0.182</td>
						</tr>
						<tr>
							<td style="width:40%">OBP</td>
							<td style="width:60%;vertical-align:middle">0.371</td>
						</tr>
						<tr>
							<td style="width:40%">SLG</td>
							<td style="width:60%;vertical-align:middle">0.490</td>
						</tr>
						<tr>
							<td style="width:40%">OPS</td>
							<td style="width:60%;vertical-align:middle">0.861</td>
						</tr>
					</tbody>
				</table>
			</div>
			<div class="col-6 col-12-xsmall">
				<table class="alt">
					<tbody style="text-align:center">
						<tr>
							<td colspan="5" style="width:100%">사회인 야구 평균</td>
						</tr>
						<tr>
							<td style="width:40%">AVG</td>
							<td style="width:60%;vertical-align:middle">0.455</td>
						</tr>
						<tr>
							<td style="width:40%">ISO</td>
							<td style="width:60%;vertical-align:middle">0.105</td>
						</tr>
						<tr>
							<td style="width:40%">OBP</td>
							<td style="width:60%;vertical-align:middle">0.542</td>
						</tr>
						<tr>
							<td style="width:40%">SLG</td>
							<td style="width:60%;vertical-align:middle">0.560</td>
						</tr>
						<tr>
							<td style="width:40%">OPS</td>
							<td style="width:60%;vertical-align:middle">1.102</td>
						</tr>
					</tbody>
				</table>
			</div>
			<div class="col-6 col-12-xsmall">
				<h3>예측 기록</h3>
				<p>AVG : 타율</p>
				<p>ISO : 순장타율</p>
				<p>OBP : 출루율</p>
				<p>SLG : 장타율</p>
				<p>OPS : 출루율 + 장타율</p>
			</div>
			<div class="col-6 col-12-xsmall">
				<h3>설명</h3>
				<p>at_bat : <?=$AT_BATdata?><br> = 8.67563*(($at_bat - 462.5093) / 54.88574) + 33.47981</p>
				<p>hit1 : <?=$HIT1data?><br> = 4.992103*(($hit1 - 96.37918) / 19.91168) + 12.75481</p>
				<p>hit2 : <?=$HIT2data?><br> = 2.625405*(($hit2 - 26.10781) / 7.323004) + 1.780769</p>
				<p>hit3 : <?=$HIT3data?><br> = 0.7691055*(($hit3 - 2.468401) / 2.646443) + 0.3326923</p>
				<p>hr : <?=$HRdata?><br> = 0.9940619*(($hr - 17.75093) / 10.84909) + 0.4721154</p>
				<p>bb : <?=$BBdata?><br> = 3.350676*((($b4 + $hbp) - 50.05948) / 17.25436) + 6.950962</p>
				<p>sf : <?=$SFdata?><br> = 0.8092592*(($sf - 4.788104) / 2.587947) + 0.5774038</p>
			</div>
		</div>
		<?=$hit_table?>
		<hr>
		<!--<span class="image main"><img src="images/pic13.jpg" alt="" /></span>-->
		<? } ?>
	</body>
</html>