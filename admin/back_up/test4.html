<? include("header/header.html");?>
<? include("header/menu.html"); ?>

<script type="text/javascript">
function changinfo(obj) {		//클릭시 리그이미지가 리그정보로 바뀌는 스크립트

	var div_id = "#"+obj;
	var check = $(div_id+" .league_box_sec").hasClass('ro_dp_n');
	
	var div_parent = $(div_id).parent().parent().parent().attr('id');
	
	var div_parent_check = $(".ro_subpage_league_box .league_box_first").hasClass('ro_dp_n');

	if(div_parent_check){
		$(".ro_subpage_league_box .league_box_first").removeClass('ro_dp_n')
		$(".ro_subpage_league_box .league_box_sec").addClass("ro_dp_n");
	}
	
	if(check){
		$(div_id+" .league_box_first").addClass("ro_dp_n");
		$(div_id+" .league_box_sec").removeClass("ro_dp_n");
	}else{
		$(div_id+" .league_box_first").removeClass("ro_dp_n");
		$(div_id+" .league_box_sec").addClass("ro_dp_n");	
	}
}
</script>
<?
$years_query = "";
$years_url = "";
if($_GET['years']){
	$years_query = "AND league_info.years = '".$_GET['years']."'";
	$years_url = "&years=".$_GET['years'];
}
$city_query = "";
$city_url = "";
if($_GET['city']){
	$city_query = " AND (";
	for($j=0; $j<count($_GET['city']); $j++){
		if($j==0){
			$city_query .= "league.address2 = '".$_GET['city'][$j]."'";
		}else{
			$city_query .= " OR league.address2 = '".$_GET['city'][$j]."'";
		}
		$city_url .= "&city[]=".$_GET['city'][$j];
		switch ($_GET['city'][$j]) {
			case 1:
				$check1 = "checked";
				break;
			case 2:
				$check2 = "checked";
				break;
			case 3:
				$check3 = "checked";
				break;
			case 4:
				$check4 = "checked";
				break;
		}
	}
	$city_query .= ")";
}
include "dbconn.php";
$league_record_query = "SELECT league_info.no, league.name as league_name, league.img AS league_img, league_info.years AS league_years, COUNT(*) AS this_record, 'hit_record' as this_title FROM league_record_hit JOIN league_info JOIN league JOIN user_player_record WHERE league_record_hit.league_info = league_info.no AND league_info.league = league.no AND league_record_hit.no = user_player_record.record AND user_player_record.position = 1 GROUP BY league_record_hit.league_info ORDER BY this_record DESC LIMIT 10";
$league_record_result = mysqli_query($conn,$league_record_query);
$league_record_table = "<table class='table' style='width:100%;text-align:center'>
							<thead>
								<tr><th>No</th><th>리그</th><th>기록</th>
							</thead>
							<tbody>";
$i = 0;							
$before_data = -9999;
while($league_record_row = mysqli_fetch_array($league_record_result)){
	if($before_data != $league_record_row['this_record']){
		$before_data = $league_record_row['this_record'];
		$i++;
	}
	if(mb_strlen($league_record_row['league_name'], 'UTF-8') <= 7){
		$league_name = $league_record_row['league_name'];
	}else{
		$league_name = mb_substr($league_record_row['league_name'], 0, 6, 'UTF-8')."‥";
	}
	$league_record_table .= "<tr><td>$i</td><td style='text-align:left'><a href='league_detail.html?no=".$league_record_row['no']."'><img src='img/logo/spogg_icon.png' class='d-inline-block align-top rounded-circle' style='width:20px;height:20px;margin-right:3px'>".$league_record_row['league_years']." ".$league_name."</a></td><td>".$league_record_row['this_record']."</td></tr>";
}
$league_record_table .= "</tbody>
					</table>";
mysqli_close($conn);
?>
<div class="ro_subpage league_contents">
	<div class="container ro_subpage_content">
		<div class="col-xs-12 col-md-9">
            <div class="row">
                <div class="to_titlebar">
                    NEW 리그
                </div>
                <div style="margin-bottom:15px;width:100%">
                    <hr>
                    <?for($i=0;$i<9;$i++){?>
                    <div class="col-xs-12 col-md-4" style="margin-bottom:5px">
                        <a href="javascript:;" style="text-decoration:none">
                            <div class="card shadow" style="padding:5px;">
                                <div class="no-gutters">
                                    <div class="col-xs-4">
                                        <img src="img/logo/spogg_icon.png" class="card-img" alt="...">
                                    </div>
                                    <div class="col-xs-8">
                                        <div class="card-body" style="padding-top:0px">
                                            <p class="card-text" style="color:#000000">리그 준비중</p>
                                            <p class="card-text"><small class="text-muted">준비중 입니다.</small></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                    <?}?>
                </div>
            </div>
            <div class="row">
                <div class="to_titlebar">
                    HOT 리그
                </div>
                <div style="margin-bottom:15px;width:100%">
                    <hr>
                    <div class="col-xs-12 col-md-4" style="margin-bottom:5px">
                        <a href="league_detail.html?no=1" style="text-decoration:none">
                            <div class="card shadow" style="padding:5px;">
                                <div class="no-gutters">
                                    <div class="col-xs-4">
                                        <img src="img/logo/spogg_icon.png" class="card-img" alt="...">
                                    </div>
                                    <div class="col-xs-8">
                                        <div class="card-body" style="padding-top:0px">
                                            <p class="card-text" style="color:#000000">2019 골드-매직리그</p>
                                            <p class="card-text"><small class="text-muted">부산/-/-</small></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="col-xs-12 col-md-4" style="margin-bottom:5px">
                        <a href="league_detail.html?no=379" style="text-decoration:none">
                            <div class="card shadow" style="padding:5px;">
                                <div class="no-gutters">
                                    <div class="col-xs-4">
                                        <img src="img/logo/spogg_icon.png" class="card-img" alt="...">
                                    </div>
                                    <div class="col-xs-8">
                                        <div class="card-body" style="padding-top:0px">
                                            <p class="card-text" style="color:#000000">2019 직장인야구연합회-한라리그</p>
                                            <p class="card-text"><small class="text-muted">부산/-/-</small></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="col-xs-12 col-md-4" style="margin-bottom:5px">
                        <a href="league_detail.html?no=2" style="text-decoration:none">
                            <div class="card shadow" style="padding:5px;">
                                <div class="no-gutters">
                                    <div class="col-xs-4">
                                        <img src="img/logo/spogg_icon.png" class="card-img" alt="...">
                                    </div>
                                    <div class="col-xs-8">
                                        <div class="card-body" style="padding-top:0px">
                                            <p class="card-text" style="color:#000000">2018 금정리그</p>
                                            <p class="card-text"><small class="text-muted">부산/-/-</small></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
			</div>
		</div>
		<div class="col-xs-12 col-md-3">
			<div class="to_titlebar">
				리그 랭킹
			</div>
			<hr>
			<div class="to_border rounded shadow" style="padding:10px 7px">
				<form>
					<select id="select_record" onchange="change_record()">
						<option value="1" selected>타자 기록 저장</option>
						<option value="2">투수 기록 저장</option>
						<option value="3">홈런</option>
					</select>
				</form>
				<div id="league_record_table" class="league_summary_record_table">
					<?=$league_record_table?>
				</div>
			</div>
		</div>
		<div class="col-xs-12 col-md-9">
			<div class="to_titlebar">
				상세 검색
			</div>
			<hr>
			<div class="row to_border rounded shadow" style="padding:20px 10px 10px 10px">
				<form action="league.html" method="get" style="width:100%">
					<div class="form-group">
						<div class="col-xs-3">
							<label class="control-label" for="years">년도</label>
						</div>
						<div class="col-xs-9">
							<select class="form-control" id="years" name="years" style="margin-top:-7px;">
								<option value=''>선택해 주세요</option>
								<?for($j=date("Y"); $j>2000; $j--){
									if($j == $_GET['years']){
										echo "<option value='".$j."' selected>".$j."년</option>";
									}else{
										echo "<option value='".$j."'>".$j."년</option>";
									}
								}?>
							</select> 
						</div>
					</div>
					<div class="form-group">
						<div class="col-xs-3" style="margin-top:10px">
							<label class="control-label" for="city">지역</label>
						</div>
						<div class="col-xs-9" style="margin-top:10px">
							<div class="col-xs-6 col-md-3">
								<input type="checkbox" class="to_check" id="city_1" name="city[]"  value="1" <?=$check1?>/>
								<label for="city_1"><span></span>부산</label>
							</div>
							<div class="col-xs-6 col-md-3">
								<input type="checkbox" class="to_check" id="city_2" name="city[]"  value="2" <?=$check2?>/>
								<label for="city_2"><span></span>울산</label>
							</div>
							<div class="col-xs-6 col-md-3">
								<input type="checkbox" class="to_check" id="city_3" name="city[]"  value="3" <?=$check3?>/>
								<label for="city_3"><span></span>경남</label>
							</div>
							<div class="col-xs-6 col-md-3">
								<input type="checkbox" class="to_check" id="city_4" name="city[]" value="4"  <?=$check4?>/>
								<label for="city_4"><span></span>기타</label>
							</div>
						</div>
					</div>
					<div class="form-group">
						<div class="col-xs-12 col-md-2" style="float:right;margin-top:10px;">						
							<button type="submit" class="btn btn-default" style="width:100%">검색</button>
						</div>
					</div>
				</form>
			</div>
		</div>
		<div class="col-xs-12 col-md-3">
			<div class="to_titlebar">
				리그 등록
			</div>
			<hr>
			<div class="to_border rounded shadow" style="padding:10px 7px">
				<h2 style="margin-top:0px">100% 무료 등록</h2>
				<h5 style="color:#515151">현재 리그에 있는 기록으로 분석이 가능합니다. 무료 세이버매트릭스 제공! 리그 등록하고 간편하게 기록을 가져오세요.</h5>
				<button type="button" class="btn btn-success" style="width:100%;">무료 등록</button>
			</div>
		</div>
	</div>
	<div class="container ro_subpage_content ro_subpage_league" id="ro_subpage_league">
		<div class="col-xs-12">
			<div class="to_titlebar">
				전체 리그
			</div>
			<hr>
			<?
			include "dbconn.php";
			$league_count_query = "SELECT COUNT(*) as count FROM league JOIN league_info WHERE league.no = league_info.league ".$years_query.$city_query;
			$league_count_result = mysqli_query($conn,$league_count_query);
			$league_count_row = mysqli_fetch_array($league_count_result);
			$end_page = ceil($league_count_row['count']/20);
			if($_GET['page'] <= 0 || $_GET['page'] == null){
				$page = 1;
			}else if($_GET['page'] >= $end_page){
				$page = $end_page;
			}else{
				$page = $_GET['page'];
			}
			$league_query = "SELECT league_info.*, 
									league.name as name,
									league.img as img,
									league.leagueclass as leagueclass,
									league.address as address  
							FROM league JOIN league_info WHERE league.deleted_at IS NULL AND league.no = league_info.league ".$years_query.$city_query." ORDER BY years DESC, league.created_at LIMIT ".(($page-1)*20).",20";
			$league_result = mysqli_query($conn,$league_query);
			$page_bar = "";
			if($end_page > 9){
				if($page - 5 <= 0){
					for($j = 0; $j < 9; $j++){
						if($page == $j + 1){
							$page_bar .= "<li class='pn_active'><a href='league.html?page=".($j+1).$years_url.$city_url."'>".($j+1)."</a></li>";
						}else{
							$page_bar .= "<li><a href='league.html?page=".($j+1).$years_url.$city_url."'>".($j+1)."</a></li>";
						}
					}
				}else if($page + 5 > $end_page){
					for($j = 8; $j >= 0; $j--){
						if($page == $end_page-$j){
							$page_bar .= "<li class='pn_active'><a href='league.html?page=".($end_page-$j).$years_url.$city_url."'>".($end_page-$j)."</a></li>";
						}else{
							$page_bar .= "<li><a href='league.html?page=".($end_page-$j).$years_url.$city_url."'>".($end_page-$j)."</a></li>";
						}
					}
				}else{
					for($j = 4; $j >0; $j--){
						$page_bar .= "<li><a href='league.html?page=".($page-$j).$years_url.$city_url."'>".($page-$j)."</a></li>";
					}
					$page_bar .= "<li class='pn_active'><a href='league.html?page=".($page).$years_url.$city_url."'>".($page)."</a></li>";
					for($j = 1; $j < 5; $j++){
						$page_bar .= "<li><a href='league.html?page=".($page+$j).$years_url.$city_url."'>".($page+$j)."</a></li>";
					}
				}
			}else{
				for($j = 0; $j < $end_page; $j++){
					if($page == $j + 1){
						$page_bar .= "<li class='pn_active'><a href='league.html?page=".($j+1).$years_url.$city_url."'>".($j+1)."</a></li>";
					}else{
						$page_bar .= "<li><a href='league.html?page=".($j+1).$years_url.$city_url."'>".($j+1)."</a></li>";
					}
				}
			}
			mysqli_close($conn);
			$i = 0;
			while($league_row = mysqli_fetch_array($league_result)){
				if($league_row['leagueclass'] == 1){
					$leagueclass = "사회인 1부";
				}else if($league_row['leagueclass'] == 2){
					$leagueclass = "사회인 2부";
				}else if($league_row['leagueclass'] == 3){
					$leagueclass = "사회인 3부";
				}else if($league_row['leagueclass'] == 4){
					$leagueclass = "사회인 4부";
				}else{
					$leagueclass = "-";
				}
				if($league_row['address']){
					$address = $league_row['address'];
				}else{
					$address = "-";
				}
			?>
				<div class="col-xs-6 col-sm-3 col-md-3 ro_subpage_league_box">
					<div class="league_box rounded shadow" id="league_box<?=$league_row['no']?>" onclick="changinfo(this.id)">
						<div class="league_box_first">
							<img src="img/logo/spogg_icon.png">
							<p><?=$league_row['years']?> <?=$league_row['name']?></p>
						</div>
						<div class="league_box_sec ro_dp_n text-center">
							<table>
								<tr>
									<th colspan="2"><b><?=$league_row['years']?> <?=$league_row['name']?></b></th>
								</tr>
								<tr>
									<th>팀수</th><td><?=$league_row['teams']?></td>
								</tr>
								<tr>
									<th>리그수준</th><td><?=$leagueclass;?></td>
								</tr>
								<tr>
									<th>지역</th><td><?=$address;?></td>
								</tr>
								<tr>
									<th>우승팀</th><td>-</td>
								</tr>
							</table>
							<span class="text-center"><button class="ro_more" onclick="location.href='league_detail.html?no=<?=$league_row['no']?>'" >상세보기</button></span>
						</div>
					</div>
				</div>
			<? } ?>
			<div class="ro_page_nation">
				<ul>
					<li><a href="league.html?page=<?echo ($page-9).$years_url.$city_url?>"><<</a></li>
					<?=$page_bar?>
					<li><a href="league.html?page=<?echo ($page+9).$years_url.$city_url?>">>></a></li>
				</ul>
			</div>
		</div>
	</div>
</div>
<script>
function change_record(){
	var selectrecord = document.getElementById("select_record");
	var selectedValue = selectrecord.options[selectrecord.selectedIndex].value;
	$.ajax({
		type: 'POST',
		url: 'league_change_record.php',
		data: {
			no : selectedValue
		},
		dataTpye: 'text',
		success: function(data){
			document.getElementById("league_record_table").innerHTML = data;
		},
		error: function() {
			alert('Error');
		}
	});
}
</script>
<? include("footer/footer.html"); ?>	
</body>
</html>