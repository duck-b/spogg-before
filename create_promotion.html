<? include("header/header.html");?>
<? include("header/menu.html"); ?>
<?
$isMobile = 0;

$mobileos = ["iPhone","iPod","Android","BlackBerry","Windows CE","Nokia","Webos","Opera Mini","SonyEricsson","Opera Mobi","IEMobile"];

for($i=0 ; $i<sizeof($mobileos); $i++) {
	if(strpos($_SERVER['HTTP_USER_AGENT'],$mobileos[$i]) !== false) {
		$isMobile = 1;
		break;
	}
}
if($isMobile){
	//모바일

}else{
	//PC

}
?>
<?
if(!$user_no){
	echo "<script>alert('로그인이 필요한 기능입니다.');";
	echo "window.location.replace('login.html');</script>";
}else{
	include "dbconn.php";
	$manager_result = mysqli_query($conn,"SELECT user_manager.no,user_manager.manager_name FROM user_manager JOIN user WHERE user_manager.user='$user_no' AND user.no = '$user_no'");
	$manager_row = mysqli_fetch_array($manager_result);
	$promotion_query = "SELECT name, CASE WHEN img is NULL THEN 'img/button/none_img.jpg' ELSE img END as img, user_manager_promotion.no ,manager_name, manager_link, contents,user_manager_promotion.updated_at, edit_info FROM user JOIN user_manager JOIN user_manager_promotion WHERE user.no = $user_no AND user_manager.user = $user_no AND user_manager.no = user_manager_promotion.user_manager ORDER BY user_manager_promotion.updated_at DESC";
	$promotion_result = mysqli_query($conn, $promotion_query);
	$promotion_list = '';
	while($promotion_row = mysqli_fetch_array($promotion_result)){
		$promotion_list .= "<div class='col-xs-12 col-sm-6 col-md-4' style='margin-bottom: 10px;'>
			<div class='card shadow' style='width:100%;height:260px'>
				<div class='card-body text-left'>
					<div class='col-xs-2'>
						<img src='".$promotion_row['img']."' class='align-top rounded-circle' style='width:100%' alt='' loading='lazy'>
					</div>
					<div class='col-xs-10'>
						<h4 class='card-title' style='margin-top:0px'>".$promotion_row['manager_name']."</h4>
						<h6 style='color:#515151'>".$promotion_row['name']." / ".$promotion_row['updated_at']." ".$promotion_row['edit_info']."</h6>
					</div>
					<div class='col-xs-12'>
						<p class='card-text border rounded' style='height:130px;overflow-y:scroll;'>".$promotion_row['contents']."</p>
						<a href='javascript:;' class='btn btn-primary' style='background-color:#5093ff;border:0px;margin-right: 5px' onclick='update_promotion(".$promotion_row['no'].")'>수정</a><a href='javascript:;' class='btn btn-danger' style='border:0px' onclick='delete_promotion(".$promotion_row['no'].")'>삭제</a>
					</div>
				</div>
			</div>
		</div>";
	}
	mysqli_close($conn);
}
?>
<div class="modal fade" id="promotionModal" tabindex="-1" aria-labelledby="promotionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="promotionModalLabel">실시간 용병경기 등록</h3>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body text-left">
        <form action="PromotionInsertProc.php" method="post">
		  <input type="hidden" name="manager_promotion" value="<?=$manager_row['no']?>">
		  <div class="form-group">
            <label for="message-title" class="col-form-label">제목</label>
            <input class="form-control" type="text" value="<?=$manager_row['manager_name']?>" disabled>
          </div>
          <div class="form-group">
            <label for="message-text" class="col-form-label">내용</label>
            <textarea class="form-control" name="contents" id="contents" rows="15" id="message-text"></textarea>
          </div>
		  <div class="text-right" style="border-top:1px solid #d7d7d7;padding-top:10px">
			<button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
			<button type="submit" class="btn btn-primary" style="background-color:#5093ff;border:0px;" onclick="insert()">등록</button>
		  </div>
        </form>
      </div>
    </div>
  </div>
</div>
<div class="ro_subpage" style="min-height:700px">	
	<div class="container record_contents">
		<div class="to_titlebar">
			실시간 용병경기 등록
		</div>
		<hr>
		<div class="to_mb_30">
			<div class="col-xs-12 col-sm-6 col-md-4" style="margin-bottom: 10px;">
                <div class="card shadow" style="width:100%;height:260px">
                    <div class="card-body text-center">
                        <a href="javascript:;" style="text-decoration: none" data-toggle="modal" data-target="#promotionModal"><i class="fa fa-plus-circle" style="color:#5093ff;font-size: 130px;margin-top:50px" aria-hidden="true"></i></a>
                    </div>
                </div>
                <?if($isMobile){
                    echo "<hr>";
                }?>
            </div>
            <?=$promotion_list?>
		</div>
	</div>
</div>
<script>
	function insert(){
		var str = document.getElementById("contents").value;
		str = str.replace(/(?:\r\n|\r|\n)/g, '<br>');
		document.getElementById("contents").value = str;
		if(doubleSubmitCheck()) return;
	}
	function update_promotion(no){
			window.open("PromotionUpdateProc.php?no="+no,
			"update_promotion","left=200, top=200, width=500, height=600, scrollbars=no,resizable=yes");
			//document.getElementById("id").disabled = true;
	}
	var doubleSubmitFlag = false;
	function doubleSubmitCheck(){
		if(doubleSubmitFlag){
			return doubleSubmitFlag;
		}else{
			doubleSubmitFlag = true;
			return false;
		}
	}
	function delete_promotion(no){
		if (confirm("정말 삭제하시겠습니까?") == true){
			location.href="PromotionDeleteProc.php?no=" + no;
		}else{ 
			return;
		}
	}
</script>
<? include("footer/footer.html"); ?>
</body>
</html>