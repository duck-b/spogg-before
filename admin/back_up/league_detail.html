<? include("header/header.html");?>
<? include("header/menu.html");?>
<?
include "dbconn.php";
$no = $_GET['no'];
$league_query = "SELECT league_info.*, 
						league.name as name,
						league.leagueclass as leagueclass,
						league.address as address,
						league.img as img
				FROM league JOIN league_info WHERE league.deleted_at IS NULL AND league.no = league_info.league AND league_info.no = $no";
$league_result = mysqli_query($conn,$league_query);
$league_row = mysqli_fetch_array($league_result);
if($league_row['leagueclass'] == 1){
	$leagueclass= "사회인 1부";
}else if($league_row['leagueclass'] == 2){
	$leagueclass= "사회인 2부";
}else if($league_row['leagueclass'] == 3){
	$leagueclass= "사회인 3부";
}else if($league_row['leagueclass'] == 4){
	$leagueclass= "사회인 4부";
}else{
	$leagueclass= "-";
}
if($league_row['address']){
	$address = $league_row['address'];
}else{
	$address= "-";
}
//팀
$league_record_team_query = "SELECT * FROM league_record_team WHERE league_info = '$no'";
$league_record_team_result = mysqli_query($conn, $league_record_team_query);
$team_table = "";
while($league_record_team_row = mysqli_fetch_array($league_record_team_result)){
	$wp = number_format(round($league_record_team_row['win_games']/($league_record_team_row['win_games']+$league_record_team_row['lose_games']),3),3);
	$team_table = $team_table."<tr>
								<td>".$league_record_team_row['num']."</td><td>".$league_record_team_row['team_name']."</td><td>".$league_record_team_row['games']."</td><td>".$league_record_team_row['win_games']."</td><td>".$league_record_team_row['lose_games']."</td><td>".$league_record_team_row['draw_games']."</td><td>".$wp."</td><td>".$league_record_team_row['win_point']."</td>
							</tr>";
}
//타자
$league_record_hit_query = "SELECT league_record_hit.*,
			ROUND(hit/at_bat,3) as avg ,
			ROUND((hit1 + hit2 + hit3 + hr + bb + hbp)/(at_bat + bb + hbp + sf),3) as obp,
			ROUND((hit1 + hit2*2 + hit3*3 +hr*4)/at_bat,3) as slg,
			ROUND(((hit1 + hit2*2 + hit3*3 +hr*4)/at_bat)+((hit1 + hit2 + hit3 + hr + bb + hbp)/(at_bat + bb + hbp + sf)),3) as ops,
			(hit1 + hit2*2 + hit3*3 + hr*4) as tb,
			(hit2 + hit3 + hr) as xbh 
		FROM league_record_hit WHERE league_info = '$no' ORDER BY num";
$league_record_hit_result = mysqli_query($conn, $league_record_hit_query);
$i=0;
$hitter_top10_table = "";
$hitter_more_table = "";
while($league_record_hit_row = mysqli_fetch_array($league_record_hit_result)){
	if($i<10){
		$hitter_top10_table = $hitter_top10_table."<tr>
								<td>".$league_record_hit_row['num']."</td><td>".$league_record_hit_row['team_name']."</td><td>".$league_record_hit_row['player_name']."</td><td>".$league_record_hit_row['at_bat']."</td><td>".$league_record_hit_row['hit']."</td><td>".$league_record_hit_row['avg']."</td>
							</tr>";
		$i++;
	}
	$hit_no = $league_record_hit_row['no'];
	if($league_record_hit_row['at_game'] == '9999'){
		$at_game = '-';
	}else{
		$at_game = $league_record_hit_row['at_game'];
	}
	if($league_record_hit_row['hbp'] == '9999'){
		$hbp = "-";
		$obp = number_format(round(($league_record_hit_row['hit'] + $league_record_hit_row['bb'])/($league_record_hit_row['at_bat'] + $league_record_hit_row['bb'] + $league_record_hit_row['sf']),3),3);
	}else{
		$hbp = $league_record_hit_row['hbp'];
		$obp = $league_record_hit_row['obp'];
	}
	if($league_record_hit_row['hit2'] == '9999' || $league_record_hit_row['hit3'] == '9999'){
		$hit2 = "-";
		$hit3 = "-";
		$slg = "-";
		$tb = "-";
		$xbh = "-";
		$ops = "-";
	}else{
		$hit2 = $league_record_hit_row['hit2'];
		$hit3 = $league_record_hit_row['hit3'];
		$slg = $league_record_hit_row['slg'];
		$tb = $league_record_hit_row['tb'];
		$xbh = $league_record_hit_row['xbh'];
		$ops = $league_record_hit_row['ops'];
	}
	$hitter_more_table = $hitter_more_table."<tr><td><a href='javascript:;' id='1_save_data_$hit_no'><i class='fa fa-download' style='color:#00b7ff' onclick='save_data($hit_no,1)';></i></a></td><td>".$league_record_hit_row['num']."</td><td>".$league_record_hit_row['team_name']."</td><td>".$league_record_hit_row['player_name']."</td><td>".$league_record_hit_row['avg']."</td><td>".$at_game."</td><td>".$league_record_hit_row['at_play']."</td><td>".$league_record_hit_row['at_bat']."</td><td>".$league_record_hit_row['hit']."</td><td>".$hit2."</td><td>".$hit3."</td><td>".$league_record_hit_row['hr']."</td><td>".$league_record_hit_row['rbi']."</td><td>".$league_record_hit_row['rs']."</td><td>".$league_record_hit_row['sb']."</td><td>".$league_record_hit_row['bb']."</td><td>".$hbp."</td><td>".$league_record_hit_row['so']."</td><td>".$league_record_hit_row['sf']."</td><td>".$tb."</td><td>".$xbh."</td><td>".$obp."</td><td>".$slg."</td><td>".$ops."</td></tr>";
}
//투수
$league_record_pit_query = "SELECT league_record_pit.*, 
			ROUND((er * 7)/(inning/3),2) as era, 
			ROUND((rs * 7)/(inning/3),2) as rsa, 
			ROUND((so)/(hbp + bb),2) as kbb, 
			ROUND((win_games)/(win_games + lose_games),3) as pct, 
			ROUND((hit + bb + hbp)/(inning/3),2) as whip 
		FROM league_record_pit WHERE league_info = '$no' ORDER BY num";
$league_record_pit_result = mysqli_query($conn, $league_record_pit_query);
$i=0;
$pitcher_top10_table = "";
$pitcher_more_table = "";
while($league_record_pit_row = mysqli_fetch_array($league_record_pit_result)){
	if($i<10 && $league_record_pit_row['player_name'] != null){
	$pitcher_top10_table = $pitcher_top10_table."<tr>
							<td>".$league_record_pit_row['num']."</td><td>".$league_record_pit_row['team_name']."</td><td>".$league_record_pit_row['player_name']."</td><td>".$league_record_pit_row['win_games']."</td><td>".$league_record_pit_row['lose_games']."</td><td>".$league_record_pit_row['hold_games']."</td><td>".$league_record_pit_row['save_games']."</td>
						</tr>";
		$i++;
	}
	if($league_record_pit_row['at_game'] == '9999'){
		$at_game = "-";
	}else{
		$at_game = $league_record_pit_row['at_game'];
	}
	if($league_record_pit_row['pitcher_count'] == '9999'){
		$pitcher_count = "-";
	}else{
		$pitcher_count = $league_record_pit_row['pitcher_count'];
	}
	if($league_record_pit_row['rs'] == '9999'){
		$rs = "-";
		$rsa = "-";
	}else{
		$rs = $league_record_pit_row['rs'];
		$rsa = $league_record_pit_row['rsa'];
	}
	if($league_record_pit_row['er'] == '9999'){
		$er = "-";
		$era = "-";
	}else{
		$er = $league_record_pit_row['er'];
		$era = $league_record_pit_row['era'];
	}
	if($league_record_pit_row['pct']){
		$pct = $league_record_pit_row['pct'];
	}else{
		$pct = "-";
	}
	$h_inning = ($league_record_pit_row['inning'] - ($league_record_pit_row['inning'] % 3)) / 3;
	if($league_record_pit_row['inning'] % 3 == 0){
		$f_inning = "";
	}else if($league_record_pit_row['inning'] % 3 == 1){
		$f_inning = "⅓";
	}else if($league_record_pit_row['inning'] % 3 == 2){
		$f_inning = "⅔";
	}
	if($league_record_pit_row['hbp'] == '9999'){
		$hbp = "-";
		$whip = number_format(round(($league_record_pit_row['hit'] + $league_record_pit_row['bb'])/($league_record_pit_row['inning']/3),2),2); 
	}else{
		$hbp = $league_record_pit_row['hbp'];
		$whip = number_format(round(($league_record_pit_row['hit'] + $league_record_pit_row['bb'] + $league_record_pit_row['hbp'])/($league_record_pit_row['inning']/3),2),2); 
	}
	$pit_no = $league_record_pit_row['no'];
	$pitcher_more_table = $pitcher_more_table."<tr><td><a href='javascript:;' id='2_save_data_$pit_no'><i class='fa fa-download' style='color:#00b7ff' onclick='save_data($pit_no,2)';></i></a></td><td>".$league_record_pit_row['num']."</td><td>".$league_record_pit_row['team_name']."</td><td>".$league_record_pit_row['player_name']."</td><td>".$era."</td><td>".$rsa."</td><td>".$at_game."</td><td>".$league_record_pit_row['win_games']."</td><td>".$league_record_pit_row['lose_games']."</td><td>".$league_record_pit_row['hold_games']."</td><td>".$league_record_pit_row['save_games']."</td><td>".$pitcher_count."</td><td>".$h_inning.$f_inning."</td><td>".$er."</td><td>".$rs."</td><td>".$league_record_pit_row['hit']."</td><td>".$league_record_pit_row['hr']."</td><td>".$league_record_pit_row['bb']."</td><td>".$hbp."</td><td>".$league_record_pit_row['so']."</td><td>".$pct."</td><td>".$whip."</td></tr>";
}
mysqli_close($conn);
?>
<!-- 모달창 -->
<div class="modal fade defaultModal_league" id="defaultModal_league">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            </div>
            <div class="modal-body" id="modal_body_league">
                <p class="modal-contents"></p>
            </div>
            <div class="modal-footer" id="modal_footer_league">
                <button type="button" class="btn btn-default" data-dismiss="modal">확인</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<!--// 모달창 -->

<div class="ro_subpage ro_subpage_leaguedetail leaguedetail2019">
	<div class="container-fluid ro_subpage_title">
		<div class="container ro_pos_a">
			<div class="row leaguedetail_info">
				<div class="leaguedetail_info_img">
					<img src="img/service_1.png" style="width:230px">
				</div>
				<div class="leaguedetail_info_content">
					<div class="leaguedetail_info_text">
						<div class="leaguedetail_info_text_title">
							<strong><?=$league_row['years'];?> <?=$league_row['name']?></strong>					
						</div>
						<div class="leaguedetail_info_text_content">
							<ul class="ro_list_title"> 
								<li><strong>팀수</strong><br>-</li>
								<li><strong>리그수준</strong><br>-</li>
								<li><strong>지역</strong><br><?=$address?></li>
								<li><strong>우승팀</strong><br>-</li>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div><!-- leaguedetail_info end -->
	</div>
	
	<div class="container ro_subpage_content ro_subpage_content_leaguedetail">
		<!-- TEAM RANKING -->
		<div class="row to_mb_50">
			<div class="col-xs-12 col-sm-12 col-md-12">
				<div class="to_titlebar">
					TEAM RANKING
				</div>
				<hr>
				<div class="table-responsive teamranking_table">
					<table class="table" id="teamranking_table">
						<thead>
							<tr>
								<th>순위</th>
								<th>팀명</th>
								<th>경기</th>
								<th>승</th>
								<th>패</th>
								<th>무</th>
								<th>승률</th>
								<th>승점</th>
							</tr>
						</thead>
						<tbody>
							<?=$team_table?>			
						</tbody>
					</table>
				</div>
				<?if(!$team_table){?>
					<p style="text-align:center">└ 준비 중 입니다</p>
				<? } ?>
			</div>
		</div>
		<!-- TEAM RANKING -->
		
		<div class="row">
			<!-- HITTER RANKING -->
			<div class="col-xs-12 col-sm-6 col-md-6 to_mb_50">
				<div class="to_titlebar">
					HITTER RANKING
					<span><a href="javascript:;" onclick="moreranking(0)">전체보기</a></span>
				</div>
				<hr>
				<div class="table-responsive ranking_table">
					<table class="table league_table">
						<tr>
							<th colspan="1" style="text-align:center;width:10%">순위</th>
							<th style="text-align:center;width:22%">팀명</th>
							<th style="text-align:center;width:17%">선수</th>
							<th style="text-align:center;width:17%">타수</th>
							<th style="text-align:center;width:17%">안타</th>
							<th style="text-align:center;width:17%">타율</th>
						</tr>
						<?=$hitter_top10_table;?>
					</table>
				</div>
			</div>
			<!-- HITTER RANKING -->
			
			<!-- PITCHER RANKING -->
			<div class="col-xs-12 col-sm-6 col-md-6 to_mb_50">
				<div class="to_titlebar">
					PITCHER RANKING
					<span><a href="javascript:;" onclick="moreranking(1)">전체보기</a></span>
				</div>
				<hr>
				<div class="table-responsive ranking_table">
					<table class="table league_table">
						<tr>
							<th colspan="1" style="text-align:center;width:10%">순위</th>
							<th style="text-align:center;width:20%">팀명</th>
							<th style="text-align:center;width:14%">선수</th>
							<th style="text-align:center;width:14%">승</th>
							<th style="text-align:center;width:14%">패</th>
							<th style="text-align:center;width:14%">홀</th>
							<th style="text-align:center;width:14%">세</th>
						</tr>
						<?=$pitcher_top10_table?>
					</table>
				</div>
			</div>
			<!-- PITCHER RANKING -->
		</div>
	</div>
</div>


<!-- IE8 에서 HTML5 요소와 미디어 쿼리를 위한 HTML5 shim 와 Respond.js -->
<!-- WARNING: Respond.js 는 당신이 file:// 을 통해 페이지를 볼 때는 동작하지 않습니다. -->
<!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->

<link href="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap.min.css" rel="stylesheet">

<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap.min.js"></script>
<script src="https://cdn.datatables.net/fixedcolumns/3.3.0/js/dataTables.fixedColumns.min.js"></script>
<script type="text/javascript">
	
	var defaultModal_league = $("#defaultModal_league");
	var modal_body_league = $("#modal_body_league");
	var modal_footer_league = $("#modal_footer_league");
	
	var append_content;
	var append_btn;
	
	var sorttableid="";
	
	
	var count = 0;
	
	/*$(document).ready(function() {
		$("#teamranking_table").DataTable({
			// 표시 건수기능 숨기기
	        lengthChange: false,
	        // 페이징 기능 숨기기
	        paging: false,
	     	// 검색 기능 숨기기
	        searching: false,
		});	
	} );*/
	
	
	function moreranking(check) {
		modal_body_league.empty();
		modal_footer_league.empty();
		if(check==0){				//타자랭킹더보기 
			
			console.log("0check : "+check);
			
			append_content = "<div class='ro_color_g'>"
							+"	<div class='to_titlebar'>"
							+"		HITTER RANKING"
							+"	</div>"
							+"	<hr>"
							+"	<div class='table table-responsive'>"
							+"	<table class=' table-hover table_h_g hiterranking_modal league_table_modal' id='hiterranking_modal'>"
							+"		<thead>"
							+"			<tr>"
							+"				<th></th><th>No</th><th>팀명</th><th>선수명</th><th>AVG</th><th>G</th><th>PA</th><th>AB</th><th>HIT</th><th>2B</th><th>3B</th><th>HR</th><th>RBI</th><th>R</th><th>SB</th><th>BB</th><th>HBP</th><th>SO</th><th>SF</th><th>TB</th><th>XBH</th><th>OBP</th><th>SLG</th><th>OPS</th>"
							+"			</tr>"
							+"		</thead>"
							+"		<tbody>"
							+"<?=$hitter_more_table;?>" 
							+"		</tbody>"				
							+"	</table></div></div>";
							
			sorttableid = '#hiterranking_modal'; 				
							
		}else{		//투수랭킹더보기 
			console.log("1check : "+check);
			append_content = "<div class='ro_color_g'>"
							+"	<div class='to_titlebar'>"
							+"		PITCHER RANKING"
							+"	</div>"
							+"	<hr>"
							+"	<div class='table table-responsive'>"
							+"	<table class='table-hover table_h_g pitcherranking_modal league_table_modal' id='pitcherranking_modal'>"
							+"		<thead>"
							+"			<tr>"
							+"				<th></th><th>No</th><th>팀명</th><th>선수명</th><th>ERA</th><th>RA</th><th>G</th><th>WIN</th><th>LOSE</th><th>HOLD</th><th>SAVE</th><th>NP</th><th>IP</th><th>ER</th><th>R</th><th>HIT</th><th>HR</th><th>BB</th><th>HBP</th><th>SO</th><th>PCT</th><th>WHIP</th>"
							+"			</tr>"
							+"		</thead>"
							+"		<tbody>"
							+"<?=$pitcher_more_table;?>" 
							+"		</tbody>"				
							+"	</table></div></div>";
			
			sorttableid = '#pitcherranking_modal'; 	
			
		}
		if(count!=0){
			table.destroy();
		}
		
		modal_body_league.append(append_content);
		table = $(sorttableid).DataTable({
			// 표시 건수기능 숨기기
	        lengthChange: false,
	        // 페이징 기능 숨기기
	        paging: false,
	        scrollY:        "400px",
	        scrollX:        true,
	        scrollCollapse: true,
	        language: {
	            search: "",
	            paginate:{
	            	"previous" : "<",
	            	"next" : ">"
	            }
	        },
		});	
		defaultModal_league.modal('show');
		count =1;
	}
	function save_data(num,pos) {
		var player_no = "<?=$player_no?>";
		document.getElementById(pos+"_save_data_"+num).innerHTML = "<i class='fas fa-spinner fa-pulse'></i>";
		if(player_no != ""){
			$.ajax({
				type: 'POST',
				url: 'save_data.php',
				data: {
					no : num,
					position : pos,
					player : player_no
				},
				dataTpye: 'text',
				success: function(data){
					document.getElementById(pos+"_save_data_"+num).innerHTML = "<i class='fa fa-download' style='color:grey'></i>";
					alert(data);
				},
				error: function() {
					alert('Error');
				}
			});
		}else{
			alert('로그인이 필요합니다.');
			location.href = "login.html";
		}
	}
	
</script>
<?include("footer/footer.html");?>	
</body>
</html>