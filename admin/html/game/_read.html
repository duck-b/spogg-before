<!DOCTYPE HTML>
<html>
<?
	include "dbconn.php";
	$no = $_GET['no'];
	$read_result = mysqli_query($conn,"SELECT * FROM game WHERE no = '$no'");
	$read_row = mysqli_fetch_array($read_result);
	if($read_row['kind'] == 1){
		$kind = "hgame";
		$game_header = "일반 경기";
		$price_text = "구장비";
		$game_date = $read_row['game_date'];
	}else if($read_row['kind'] == 2){
		$kind = "agame";
		$game_header = "일반 경기 (원정)";
		$price_text = "구장비";
		$game_time = strtotime($read_row['game_date']);
		$game_date = date('Y-m-d' , $game_time);
	}else if($read_row['kind'] == 3){
		$kind = "merc";
		$game_header = "용병 경기";
		$price_text = "참가비";
		$game_date = $read_row['game_date'];
	}else if($read_row['kind'] == 4){
		$kind = "stadium";
		$game_header = "구장 양도";
		$price_text = "구장비";
		$game_date = $read_row['game_date'];
	}
	if($read_row['kind'] == 1 || $read_row['kind'] == 2){
		$team_no = $read_row['team'];
		$team_result = mysqli_query($conn,"SELECT * FROM team WHERE no = '$team_no'");
		$team_row = mysqli_fetch_array($team_result);
	}
	if($read_row['deleted_at']){
		echo "<script>alert('삭제된 게시글 입니다');";
		echo "window.location.replace('game.html?game=$kind');</script>";
	}else{
		mysqli_query($conn,"UPDATE game_view SET views = views + 1 WHERE game = '$no'");
	}
	$board_activiy_result = mysqli_query($conn, "SELECT * FROM user_activity where user = '$user_no' AND board = '$no' AND board_table = 'game'");
	$board_activiy_row = mysqli_fetch_array($board_activiy_result);
	if($board_activiy_row){
		$activity_no = $board_activiy_row['no'];
		mysqli_query($conn,"UPDATE user_activity SET count = '0' WHERE no = '$activity_no'");
	}
	if($kind == 'merc'){
		$merc_activ_result = mysqli_query($conn,"SELECT * FROM game_merc WHERE game = '$no' AND user = '$user_no'");
		while($merc_activ_row = mysqli_fetch_array($merc_activ_result)){
			$board_no = $merc_activ_row['no'];
			$board_activiy_result = mysqli_query($conn, "SELECT * FROM user_activity where board = '$board_no' AND board_table = 'game_merc'");
			$board_activiy_row = mysqli_fetch_array($board_activiy_result);
			if($board_activiy_row){
				$activity_no = $board_activiy_row['no'];
				mysqli_query($conn,"UPDATE user_activity SET count = '0' WHERE no = '$activity_no'");
			}
		}
	}
	$writer_no = $read_row['user'];
	$game_no = $read_row['no'];
	$writer_result = mysqli_query($conn,"SELECT * FROM user WHERE no = '$writer_no'");
	$writer_row = mysqli_fetch_array($writer_result);
	$view_result = mysqli_query($conn,"SELECT * FROM game_view WHERE game='$game_no'");
	$view_row = mysqli_fetch_array($view_result);
	$comments = mysqli_query($conn,"SELECT COUNT(*) as count FROM game_comment WHERE game='$game_no'");
	$comments_count = mysqli_fetch_array($comments);
	$states_result = mysqli_query($conn,"SELECT * FROM game_states where game='$game_no'");
	$states_row = mysqli_fetch_array($states_result);
	if($comments_count['count'] >= 1){
		$comments = mysqli_query($conn,"SELECT * FROM game_comment WHERE game='$game_no'");
	}else{
		$comments = null;
	}
	if($read_row['adrs'] == 1){
		$adrs = '서울';
	}elseif($read_row['adrs'] == 2){
		$adrs = '경기';
	}elseif($read_row['adrs'] == 3){
		$adrs = '강원';
	}elseif($read_row['adrs'] == 4){
		$adrs = '충청';
	}elseif($read_row['adrs'] == 5){
		$adrs = '전라';
	}elseif($read_row['adrs'] == 6){
		$adrs = '경상';
	}elseif($read_row['adrs'] == 7){
		$adrs = '제주';
	}
	if($states_row['states'] == 2){
		$end_comment = "<a style='color:red'>(※ 신청이 마감된 게시글 입니다)</a>";
	}
?>
	<body onload="read_contents()">
		<section class="site-section">
			<div class="container">
				<div class="row">
					<div class="col-lg-2"></div>
					<div class="col-lg-8 col-md-12 mb-5 element-animate">
						<div class="row">
							<div class="col-md-12">
								<h3 class="mb-5" style="vertical-align: middle;"><? echo $game_header; ?></h3>
							</div>
							<table class="table table-bordered" style="vertical-align: middle;">
								<thead>
									<tr>
										<th colspan="1" style="width:10%">제목</th>
										<td colspan="5" style="width:90%"><? echo $read_row['title'];?>&nbsp;<? echo $end_comment;?></td>
									</tr>
								</thead>
								<tbody>
									<tr>
										<th colspan="1" style="width:10%">작성자</th>
										<td colspan="1" style="width:20%"><a href="user.html?user=info&no=<? echo $writer_no;?>"><? echo $writer_row['name'];?></a></td>
										<th colspan="1" style="width:10%">시간</th>
										<? if ($read_row['created_at'] == $read_row['updated_at']){?>
										<td colspan="1"  style="vertical-align: middle;width:40%;"><? echo $read_row['created_at'];?>에 작성됨</td>
										<? } else {?>
										<td colspan="1"  style="vertical-align: middle;width:40%"><? echo $read_row['updated_at'];?>에 수정됨</td>
										<? } ?>
										<th colspan="1" style="width:10%">조회수</th>
										<td colspan="1" style="width:10%"><? echo $view_row['views']?></td>
									</tr>
									<tr>
										<td colspan="6" style="width:90%">
											<? if($kind == "hgame" || $kind == "agame"){?>
											<p>팀 이름 : <a href="team.html?team=info&no=<? echo $team_no?>"><? echo $team_row['name'];?></a></p>
											<? } ?>
											<p>날짜 : <? echo $game_date;?></p>
											<? if($kind != "agame"){?>
											<p>장소 : <? echo $read_row['stadium_name'];?></p>
											<p><? echo $price_text;?> : <? echo $read_row['stadium_price'];?>원</p>
											<? } ?>
											<p>지역 : <? echo $adrs;?></p>
											<p id="contents"><? echo $read_row['contents'];?></p>
											<? include("game/_mercposition.html"); ?>
										</td>
									</tr>
									<tr>
										<th colspan="1" style="width:10%">댓글</th>
										<td colspan="5" style="width:90%"><? echo $comments_count['count'];?> 개</td>
									</tr>
									<? if ($comments != null){
										while($comments_row = mysqli_fetch_array($comments)){
											$commenter_no = $comments_row['user'];
											$commenter_result = mysqli_query($conn,"SELECT * FROM user WHERE no = '$commenter_no'");
											$commenter_row = mysqli_fetch_array($commenter_result);		
											$comment_no = $comments_row['no'];
											$recomment_result = mysqli_query($conn,"SELECT * FROM game_recomment WHERE comment = '$comment_no'");
											$comment_activiy_result = mysqli_query($conn, "SELECT * FROM user_activity where user = '$user_no' AND board = '$comment_no' AND board_table = 'game_comment'");
											$comment_activiy_row = mysqli_fetch_array($comment_activiy_result);
											if($comment_activiy_row){
												$activity_no = $comment_activiy_row['no'];
												mysqli_query($conn,"UPDATE user_activity SET count = '0' WHERE no = '$activity_no'");
											}	
									?>
									<tr>
										<td colspan="6" style="width:100%">
											<div class = "row">
												<div class="col-md-2">
													<a href="user.html?user=info&no=<? echo $commenter_no;?>"><? echo $commenter_row['name'];?></a>
												</div>
												<div class="col-md-5">
													<? if(!$comments_row['deleted_at']){?>
														<? if ($comments_row['created_at'] == $comments_row['updated_at']){?>
													<p style="font-size:80%"><? echo $comments_row['created_at'];?>에 작성됨</p>
														<? } else {?>
													<p style="font-size:80%"><? echo $comments_row['updated_at'];?>에 수정됨</p>
														<? } ?>
													<? }else{?>
													<p style="font-size:80%"><? echo $comments_row['deleted_at'];?>에 삭제됨</p>
													<? } ?>
												</div>
												<div class="col-md-2"></div>
												<div class="col-md-3">
													<a href="javascript:;" style="text-align:right" onclick="recomment_bt('<? echo $comments_row['no'];?>')">답글</a>
													<? if($user_no == $commenter_no && $comments_row['deleted_at'] == null){?>
													<a href="javascript:;" style="text-align:right" id="comment_edit_bt_<? echo $comments_row['no'];?>" onclick="comment_edit_bt('<? echo $comments_row['no'];?>')">수정</a>
													<a href="javascript:;" style="text-align:right;color:red" onclick="delete_event('<? echo $comments_row['no'];?>','comment')">삭제</a>
													<? } ?>
												</div>
												<? if(!$comments_row['deleted_at']){?>
												<div class="col-md-12" id="comment_<? echo $comments_row['no']?>"><? echo $comments_row['contents'];?></div>
												<? } else { ?>
												<div class="col-md-12">삭제된 댓글 입니다</div>
												<? } ?>
												<div class ="col-md-2" id="blanks_<? echo $comments_row['no']?>" style="display: none"></div>
												<div class ="col-md-10" id="recomment_<? echo $comments_row['no']?>" style="display: none">
													<form action="GameInsertProc.php" method="post">
														<div class="input-group">
															<input type="text" name="contents" class="form-control" placeholder="답글을 작성해 주세요" aria-describedby="basic-addon2">
															<input type="hidden" name="kind" value="recomment">
															<input type="hidden" name="comment" value="<? echo $comment_no;?>">
															<input type="hidden" name="game" value="<? echo $game_no;?>">
															<div class="input-group-append">
																<button class="btn btn-outline-primary" type="submit">답글 작성</button>
															</div>
														</div>
													</form>
													<br>
												</div>
												<? while($recomments_row = mysqli_fetch_array($recomment_result)){ 
												$recommenter_no = $recomments_row['user'];
												$recommenter_result = mysqli_query($conn,"SELECT * FROM user WHERE no = '$recommenter_no'");
												$recommenter_row = mysqli_fetch_array($recommenter_result);	
												?>
												<div class ="col-md-2" style="margin-top:3%;padding-left:5%"><i class="fas fa-level-up-alt fa-rotate-90"></i></div>
												<div class ="row col-md-10" style="border-top:1px solid #dee2e6;">
													<div class="col-md-2">
														<a href="user.html?user=info&no=<? echo $recommenter_no;?>"><? echo $recommenter_row['name'];?></a>
													</div>
													<div class="col-md-5">
														<? if(!$recomments_row['deleted_at']){?>
															<? if ($recomments_row['created_at'] == $recomments_row['updated_at']){?>
														<p style="font-size:80%"><? echo $recomments_row['created_at'];?>에 작성됨</p>
															<? } else {?>
														<p style="font-size:80%"><? echo $recomments_row['updated_at'];?>에 수정됨</p>
															<? } ?>
														<? }else{ ?>
														<p style="font-size:80%"><? echo $recomments_row['deleted_at'];?>에 삭제됨</p>
														<? } ?>
													</div>
													<div class="col-md-2"></div>
													<div class="col-md-3">
														<? if($user_no == $recommenter_no && $recomments_row['deleted_at'] == null){?>
														<a href="javascript:;" id="recomment_edit_bt_<? echo $recomments_row['no'];?>" onclick="recomment_edit_bt('<? echo $recomments_row['no'];?>')">수정</a>
														<a href="javascript:;" style="color:red" onclick="delete_event('<? echo $recomments_row['no'];?>','recomment')">삭제</a>
														<? } ?>
													</div>
													<? if(!$recomments_row['deleted_at']){?>
													<div class="col-md-12" id="recomment_contents_<? echo $recomments_row['no']?>"><? echo $recomments_row['contents'];?></div>
													<? } else {?>
													<div class="col-md-12">삭제된 답글 입니다</div>
													<? } ?>
												</div>
												<? } ?>
											</div>
										</td>
									</tr>
									<? }
									} ?>
									<? 	mysqli_close($conn); ?>
									<tr>
										<th colspan="6" style="width:100%">
											<form action="GameInsertProc.php" method="post">
												<div class="input-group mb-3">
													<input type="text" name="contents" class="form-control" placeholder="댓글을 작성해 주세요" aria-describedby="basic-addon2">
													<input type="hidden" name="kind" value="comment">
													<input type="hidden" name="game" value="<? echo $game_no;?>">
													<div class="input-group-append">
														<button class="btn btn-outline-primary" type="submit">댓글 작성</button>
													</div>
												</div>
											</form>
										</th>
									</tr>
								</tbody>
							</table>
							<div class="col-md-2"></div>
							<div class="col-md-2">
								<? if($user_no == $writer_no && $states_row['states'] == 1){?>
								<a class="btn btn-success" href="javascript:;" role="button" onclick="end_event('<? echo $game_no;?>')">마&nbsp;&nbsp;&nbsp;감</a>
								<? } ?>
							</div>
							<div class="col-md-2">
								<? if($user_no == $writer_no){?>
								<a class="btn btn-danger" href="javascript:;" role="button" onclick="delete_event('<? echo $game_no;?>','game')">삭&nbsp;&nbsp;&nbsp;제</a>
								<? } ?>
							</div>
							<div class="col-md-2">
								<? if($user_no == $writer_no){?>
								<a class="btn btn-primary" href="game.html?game=edit&no=<? echo $game_no;?>" role="button">수&nbsp;&nbsp;&nbsp;정</a>
								<? } ?>
							</div>
							<div class="col-md-2">
								<a class="btn btn-primary" href="game.html?game=<? echo $kind?>" role="button">목&nbsp;&nbsp;&nbsp;록</a>
							</div>
							<div class="col-md-2">
								<a class="btn btn-primary" href="game.html?game=write&kind=<? echo $kind?>" role="button">글쓰기</a>
							</div>
						</div>
					</div>
					<div class="col-lg-2"></div>
				</div>
			</div>
		</section>
	</body>
</html>